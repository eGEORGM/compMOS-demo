openapi: 3.0.3
info:
  title: 结算平台 - 账单管理API
  description: 账单列表查询、账单详情、账单确认、撤销确认等接口
  version: 1.0.0
  contact:
    name: compMOS Team
    email: support@compmos.com

servers:
  - url: https://api.compmos.com/v1
    description: 生产环境
  - url: https://api-staging.compmos.com/v1
    description: 测试环境
  - url: http://localhost:3000/api/v1
    description: 本地开发环境

tags:
  - name: bills
    description: 账单管理相关接口

paths:
  /bills:
    get:
      tags:
        - bills
      summary: 获取账单列表
      description: 获取企业的账单包列表，支持按日期范围、状态筛选和分页
      operationId: getBillList
      parameters:
        - name: startDate
          in: query
          description: 结算开始日期
          required: true
          schema:
            type: string
            format: date
            example: "2025-01-01"
        - name: endDate
          in: query
          description: 结算结束日期（最多180天）
          required: true
          schema:
            type: string
            format: date
            example: "2025-12-31"
        - name: status
          in: query
          description: 账单状态筛选
          required: false
          schema:
            type: integer
            enum: [0, 1, 2, 3, 4]
            description: 0-待确认, 1-待开票, 2-开票中, 3-待付款, 4-已结清
        - name: page
          in: query
          description: 页码（从1开始）
          required: false
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: pageSize
          in: query
          description: 每页数量
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: 成功返回账单列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      list:
                        type: array
                        items:
                          $ref: '#/components/schemas/BillSummary'
                      total:
                        type: integer
                        description: 总记录数
                        example: 156
                      page:
                        type: integer
                        example: 1
                      pageSize:
                        type: integer
                        example: 20
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bills/{billNo}:
    get:
      tags:
        - bills
      summary: 获取账单详情
      description: 获取指定账单的完整详情信息，包括汇总统计、企业信息等
      operationId: getBillDetail
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
            example: "BILL-2025-001"
      responses:
        '200':
          description: 成功返回账单详情
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/BillDetail'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bills/{billNo}/confirm:
    post:
      tags:
        - bills
      summary: 确认账单
      description: |
        确认指定账单，将账单状态变更为"待开票"，同时将账单内所有订单的核对状态变更为"已核对"。
        此操作会记录确认时间和确认人信息。
      operationId: confirmBill
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
            example: "BILL-2025-001"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                billNo:
                  type: string
                  description: 账单号（用于二次确认）
                  example: "BILL-2025-001"
              required:
                - billNo
      responses:
        '200':
          description: 账单确认成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "账单确认成功"
                  data:
                    type: object
                    properties:
                      billNo:
                        type: string
                        example: "BILL-2025-001"
                      billStatus:
                        type: integer
                        description: 更新后的账单状态（1-待开票）
                        example: 1
                      confirmTime:
                        type: string
                        format: date-time
                        example: "2026-01-22T10:30:00Z"
                      confirmBy:
                        type: string
                        description: 确认人用户ID
                        example: "user123"
                      updatedOrderCount:
                        type: integer
                        description: 更新的订单数量
                        example: 150
        '400':
          description: 请求参数错误或账单状态不允许确认
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 10002
                  message:
                    type: string
                    example: "账单状态不允许此操作"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bills/{billNo}/cancel-confirm:
    post:
      tags:
        - bills
      summary: 撤销账单确认
      description: |
        撤销账单确认，将账单状态回退到"待确认"，同时将所有订单的核对状态回退到"未核对"。
        仅允许在"待开票"状态撤销，进入"开票中"后不可撤销。
      operationId: cancelBillConfirm
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
            example: "BILL-2025-001"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                billNo:
                  type: string
                  description: 账单号（用于二次确认）
                  example: "BILL-2025-001"
                reason:
                  type: string
                  description: 撤销原因（可选）
                  example: "发现订单数据有误，需要重新核对"
              required:
                - billNo
      responses:
        '200':
          description: 撤销确认成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "撤销确认成功"
                  data:
                    type: object
                    properties:
                      billNo:
                        type: string
                        example: "BILL-2025-001"
                      billStatus:
                        type: integer
                        description: 回退后的账单状态（0-待确认）
                        example: 0
                      revertedOrderCount:
                        type: integer
                        description: 回退的订单数量
                        example: 150
        '400':
          description: 账单状态不允许撤销（已进入开票中）
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 10002
                  message:
                    type: string
                    example: "账单已进入开票流程，无法撤销确认"
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bills/{billNo}/orders:
    get:
      tags:
        - bills
      summary: 获取账单订单列表
      description: 获取指定账单的订单明细列表，支持按业务类型、核对状态、出行人等条件筛选
      operationId: getBillOrders
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
            example: "BILL-2025-001"
        - name: businessType
          in: query
          description: 业务类型筛选
          required: false
          schema:
            type: string
            enum: [flight, hotel, train, car]
        - name: checkStatus
          in: query
          description: 核对状态筛选
          required: false
          schema:
            type: integer
            enum: [0, 1]
            description: 0-未核对, 1-已核对
        - name: travelerName
          in: query
          description: 出行人姓名搜索（模糊匹配）
          required: false
          schema:
            type: string
        - name: legalEntity
          in: query
          description: 法人实体筛选
          required: false
          schema:
            type: string
        - name: orderNos
          in: query
          description: 批量查询的订单号列表（逗号分隔，最多500个）
          required: false
          schema:
            type: string
            example: "ORD-001,ORD-002,ORD-003"
        - name: page
          in: query
          description: 页码
          required: false
          schema:
            type: integer
            default: 1
        - name: pageSize
          in: query
          description: 每页数量
          required: false
          schema:
            type: integer
            default: 100
            maximum: 500
      responses:
        '200':
          description: 成功返回订单列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      list:
                        type: array
                        items:
                          $ref: '#/components/schemas/OrderDetail'
                      total:
                        type: integer
                        example: 1580
                      page:
                        type: integer
                        example: 1
                      pageSize:
                        type: integer
                        example: 100
                      summary:
                        type: object
                        description: 当前筛选结果的汇总统计
                        properties:
                          totalAmount:
                            type: number
                            description: 总金额
                            example: 124567.89
                          totalCount:
                            type: integer
                            description: 总订单数
                            example: 1580
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /bills/{billNo}/export/excel:
    post:
      tags:
        - bills
      summary: 导出账单Excel
      description: 根据用户配置的字段导出账单订单明细为Excel文件（前端直接生成，此接口保留用于后端生成）
      operationId: exportBillExcel
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fields:
                  type: array
                  description: 要导出的字段keys
                  items:
                    type: string
                  example: ["orderNo", "businessType", "travelerName", "payAmount"]
                filters:
                  type: object
                  description: 筛选条件（可选）
                  properties:
                    businessType:
                      type: string
                    checkStatus:
                      type: integer
      responses:
        '200':
          description: 返回Excel文件
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

  /bills/{billNo}/export/pdf:
    post:
      tags:
        - bills
      summary: 导出账单PDF
      description: 根据用户配置的字段导出账单对账单为PDF文件（带企业公章）
      operationId: exportBillPDF
      parameters:
        - name: billNo
          in: path
          description: 账单号
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fields:
                  type: array
                  description: 要导出的字段keys（最多20个）
                  maxItems: 20
                  items:
                    type: string
                  example: ["orderNo", "businessType", "travelerName", "payAmount"]
                filters:
                  type: object
                  description: 筛选条件（可选）
      responses:
        '200':
          description: 返回PDF文件
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '400':
          description: 字段数量超过20个
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 400
                  message:
                    type: string
                    example: "PDF导出字段最多20个"

components:
  schemas:
    BillSummary:
      type: object
      description: 账单列表项
      properties:
        billNo:
          type: string
          description: 账单号
          example: "BILL-2025-001"
        billPeriod:
          type: string
          description: 结算周期
          example: "2025-09"
        startDate:
          type: string
          format: date
          description: 结算开始日期
          example: "2025-09-01"
        endDate:
          type: string
          format: date
          description: 结算结束日期
          example: "2025-09-30"
        billStatus:
          type: integer
          description: 账单状态（0-待确认, 1-待开票, 2-开票中, 3-待付款, 4-已结清）
          enum: [0, 1, 2, 3, 4]
          example: 0
        totalAmount:
          type: number
          description: 账单总金额（元）
          example: 49144.76
        pendingInvoiceAmount:
          type: number
          description: 待开票金额（元）
          example: 49144.76

    BillDetail:
      type: object
      description: 账单详情
      properties:
        billNo:
          type: string
          example: "BILL-2025-001"
        billPeriod:
          type: string
          example: "2025-09"
        startDate:
          type: string
          format: date
          example: "2025-09-01"
        endDate:
          type: string
          format: date
          example: "2025-09-30"
        billStatus:
          type: integer
          example: 0
        totalAmount:
          type: number
          example: 49144.76
        pendingInvoiceAmount:
          type: number
          example: 49144.76
        invoicedAmount:
          type: number
          description: 已开票金额
          example: 0
        confirmTime:
          type: string
          format: date-time
          nullable: true
          description: 确认时间
          example: null
        confirmBy:
          type: string
          nullable: true
          description: 确认人用户ID
          example: null
        amountByBusiness:
          type: object
          description: 各业务线金额统计
          properties:
            flight:
              type: number
              example: 30000.00
            hotel:
              type: number
              example: 15000.00
            train:
              type: number
              example: 3144.76
            car:
              type: number
              example: 1000.00
        orderCountByBusiness:
          type: object
          description: 各业务线订单数量统计
          properties:
            flight:
              type: integer
              example: 80
            hotel:
              type: integer
              example: 50
            train:
              type: integer
              example: 15
            car:
              type: integer
              example: 5
            total:
              type: integer
              example: 150
        companyInfo:
          type: object
          description: 企业信息
          properties:
            companyName:
              type: string
              example: "厦门合思宏盛有限公司"
            accountType:
              type: string
              enum: [prepaid, credit]
              description: 账户类型（预存/授信）
              example: "prepaid"
            creditLimit:
              type: number
              nullable: true
              description: 信用额度（授信账户）
              example: null
            balance:
              type: number
              nullable: true
              description: 账户余额（预存账户）
              example: 500000.00

    OrderDetail:
      type: object
      description: 订单明细
      properties:
        orderNo:
          type: string
          example: "ORD-2025-001"
        billNo:
          type: string
          example: "BILL-2025-001"
        businessType:
          type: string
          enum: [flight, hotel, train, car]
          example: "flight"
        checkStatus:
          type: integer
          enum: [0, 1]
          description: 核对状态（0-未核对, 1-已核对）
          example: 0
        bookingDate:
          type: string
          format: date
          description: 预订日期
          example: "2025-09-15"
        travelDate:
          type: string
          format: date
          description: 出行日期
          example: "2025-09-20"
        bookerName:
          type: string
          description: 预订人姓名
          example: "张三"
        travelerName:
          type: string
          description: 出行人姓名
          example: "李四"
        payAmount:
          type: number
          description: 支付金额（元）
          example: 1580.00
        legalEntity:
          type: string
          description: 法人实体
          example: "北京分公司"
        paymentAccount:
          type: string
          description: 支付账户
          example: "企业账户A"
        costCenter:
          type: string
          nullable: true
          description: 成本中心
          example: "市场部"
        projectDept:
          type: string
          nullable: true
          description: 项目部门
          example: "数字营销项目组"
        expenseType:
          type: string
          description: 费用类型
          example: "差旅费"
        businessInfo:
          type: object
          description: 业务特有字段（根据businessType不同）
          oneOf:
            - $ref: '#/components/schemas/FlightBusinessInfo'
            - $ref: '#/components/schemas/HotelBusinessInfo'
            - $ref: '#/components/schemas/TrainBusinessInfo'
            - $ref: '#/components/schemas/CarBusinessInfo'

    FlightBusinessInfo:
      type: object
      description: 机票业务特有字段
      properties:
        flightNo:
          type: string
          example: "CA1234"
        departureTime:
          type: string
          format: date-time
          example: "2025-09-20T08:00:00Z"
        route:
          type: string
          description: 航线
          example: "北京→上海"
        cabinClass:
          type: string
          description: 舱位等级
          example: "经济舱"
        ticketNo:
          type: string
          description: 电子客票号
          example: "7811234567890"

    HotelBusinessInfo:
      type: object
      description: 酒店业务特有字段
      properties:
        hotelName:
          type: string
          example: "北京希尔顿酒店"
        checkInDate:
          type: string
          format: date
          example: "2025-09-20"
        checkOutDate:
          type: string
          format: date
          example: "2025-09-22"
        roomCount:
          type: integer
          example: 1
        roomType:
          type: string
          example: "高级大床房"
        guestName:
          type: string
          example: "李四"

    TrainBusinessInfo:
      type: object
      description: 火车票业务特有字段
      properties:
        trainNo:
          type: string
          example: "G1234"
        departureTime:
          type: string
          format: date-time
          example: "2025-09-20T14:00:00Z"
        trainRoute:
          type: string
          description: 线路
          example: "北京南→上海虹桥"
        seatClass:
          type: string
          description: 座位等级
          example: "二等座"
        idCardLast4:
          type: string
          description: 身份证号后四位
          example: "1234"

    CarBusinessInfo:
      type: object
      description: 用车业务特有字段
      properties:
        carTime:
          type: string
          format: date-time
          example: "2025-09-20T10:00:00Z"
        startPoint:
          type: string
          example: "北京首都国际机场"
        endPoint:
          type: string
          example: "北京市朝阳区XXX大厦"
        carModel:
          type: string
          example: "舒适型"
        mileage:
          type: number
          description: 行驶里程（公里）
          example: 35.8

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: integer
                example: 400
              message:
                type: string
                example: "请求参数错误"

    Unauthorized:
      description: 未授权或登录已过期
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: integer
                example: 401
              message:
                type: string
                example: "登录已过期，请重新登录"

    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: integer
                example: 404
              message:
                type: string
                example: "账单不存在"

    InternalServerError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            type: object
            properties:
              code:
                type: integer
                example: 500
              message:
                type: string
                example: "服务器错误，请稍后重试"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []

