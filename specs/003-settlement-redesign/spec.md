# Feature Specification: 结算平台UI重构

**Feature Branch**: `003-settlement-redesign`  
**Created**: 2026-01-22  
**Updated**: 2026-01-22  
**Status**: Draft  
**Input**: 基于目前完成的内容做出修改 - 简化UI结构，优化账单流程，确保前两步完全流转且数据展示完备

## 概述

本次重构旨在简化结算平台的用户界面结构，优化账单处理流程，并确保数据展示的完整性和状态流转的准确性。主要变更包括：

### 核心改进

1. **简化系统导航**：移除侧边栏导航菜单，以单一账单列表页作为系统入口，减少用户的认知负担
2. **优化状态流转**：重新设计账单详情页的状态流转（确认账单→提交发票），确保前两步流程完全流转且数据同步准确
3. **增强数据展示**：在账单汇总、账单明细、开票汇总等各个环节展示完整的必要数据字段，满足财务人员对账需求
4. **完善开票流程**：提供直观的一键开票功能，包含完整的开票信息填写、验证、确认环节

### 数据完整性保障

本次重构特别强调数据展示的完整性和充分性：

- **账单汇总**：展示总金额、各业务线金额及占比、订单数量统计、企业信息、结算周期等完整信息
- **账单明细**：每条订单记录包含通用字段（7个）+ 业务特有字段（5个）+ 财务字段（5个），确保财务人员可以完整核对
- **开票汇总**：展示应开票金额、已开票金额、还可提交金额、发票明细表（按种类和摘要拆分）、发票抬头列表等全部必要数据
- **开票信息**：每行开票信息包含8个必要字段，且提供实时验证和清晰的必填标记

### 流程完整性保障

确保"待确认"到"待开票"、再到"开票中"的状态流转完整且准确：

- **状态同步**：确认账单时，账单状态和所有订单状态同步变更，撤销确认时完全回退
- **数据一致性**：所有状态变更操作记录操作时间和操作人，保证数据可追溯
- **错误处理**：任何操作失败都保持原状态不变，并提供明确的错误提示和重试机制
- **流程可逆**：在"待开票"状态支持撤销确认，允许用户回退到上一状态重新核对

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看和筛选账单列表 (Priority: P1)

企业财务人员登录系统后，直接进入账单列表页面，可以快速查看本企业所有结算周期的账单包数据，并通过多种条件进行筛选查询。

**Why this priority**: 这是系统的核心入口功能，用户必须能够快速找到需要处理的账单才能进行后续操作。没有这个功能，系统无法使用。

**Independent Test**: 用户登录后能够看到账单列表，使用日期范围、状态、订单号等条件进行筛选，并查看筛选结果。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统，**When** 进入系统，**Then** 直接显示账单列表页（无侧边栏菜单），默认显示最近一个月的账单包数据
2. **Given** 在账单列表页，**When** 选择日期范围（最多180天），**Then** 列表更新显示该时间范围内的账单包
3. **Given** 在账单列表页，**When** 选择账单状态（待确认/调账中/待开票/待付款/已结清），**Then** 列表仅显示该状态的账单包
4. **Given** 在账单列表页，**When** 输入订单号并点击搜索，**Then** 跳转到该订单所在账单包的详情页，并自动在订单明细中搜索该订单号
5. **Given** 在账单列表页，**When** 查看列表，**Then** 每条记录显示：结算周期、状态、账单总计、待开票金额、查看详情操作按钮

---

### User Story 2 - 查看和确认账单详情（含完整数据展示） (Priority: P1)

企业财务人员点击账单详情后，可以查看账单的完整汇总信息和各业务线的详细明细数据，系统必须展示所有必要的数据字段以供财务人员核对。确认账单无误后进行确认操作，推进账单进入下一状态。

**Why this priority**: 账单确认是核心业务流程的第一步，是后续开票和付款的前置条件。数据展示的完整性直接影响财务人员的对账准确性，必须优先实现。

**Independent Test**: 用户可以打开任意账单，查看完整的汇总和明细数据（包含所有业务线统计、订单字段、金额明细等），点击确认按钮完成账单确认，账单状态更新为"待开票"，所有相关数据正确同步。

**Acceptance Scenarios**:

1. **Given** 在账单列表页，**When** 点击"查看详情"，**Then** 进入账单详情页，显示4步流程（确认账单→提交发票→付款→已结清）
2. **Given** 账单状态为"待确认"，**When** 进入详情页，**Then** 显示两个tab：账单汇总和账单明细
3. **Given** 在账单汇总tab，**When** 查看数据，**Then** 显示完整的账单汇总信息，包括：
   - 本期账单消费金额合计（总金额）
   - 按业务线拆分的金额统计（机票金额、酒店金额、火车票金额、用车金额）
   - 订单数量统计（总订单数、各业务线订单数）
   - 结算周期时间范围（开始日期~结束日期）
   - 企业基本信息（企业名称、账户类型、信用额度/余额）
   - 明细设置按钮（支持多维度拆分配置）
4. **Given** 在账单汇总tab点击"明细设置"，**When** 配置拆分维度后，**Then** 账单明细数据按照配置的维度（业务线/法人实体/支付账户/部门）进行多层级树形展示，每个层级显示该维度的汇总金额和订单数量
5. **Given** 在账单明细tab，**When** 查看数据，**Then** 显示各业务线（机票/酒店/火车票/用车）的明细数据，有数据的业务线才显示子tab
6. **Given** 在账单明细tab的任一业务线子tab，**When** 查看订单列表，**Then** 每条订单记录必须显示完整字段，包括：
   - **通用字段**：订单号、预订日期、出行日期、预订人、出行人、支付金额、核对状态
   - **机票特有字段**：航班号、起飞时间、航线（出发地→目的地）、舱位等级、电子客票号
   - **酒店特有字段**：酒店名称、入住日期、离店日期、房间数量、房型、入住人姓名
   - **火车票特有字段**：车次、出发时间、线路（出发站→到达站）、座位等级、乘车人身份证号后四位
   - **用车特有字段**：用车时间、起点、终点、车型、行驶里程
   - **财务字段**：法人实体、支付账户、成本中心、项目部门、费用类型
7. **Given** 在账单明细tab，**When** 使用搜索功能，**Then** 可以按订单号、核对状态、入住人/出行人、法人实体等条件筛选订单，搜索结果实时更新，并显示匹配条数
8. **Given** 在账单明细tab底部，**When** 查看汇总信息，**Then** 显示当前筛选/查看的订单的汇总统计：总订单数、总金额、各支付方式金额小计
9. **Given** 在账单详情页，**When** 点击"确认账单"按钮，**Then** 弹出二次确认窗口，显示"是否确认X~Y账单金额无误"，并展示关键金额数据（总金额、各业务线金额）
10. **Given** 在确认弹窗，**When** 点击确认，**Then** 账单状态变更为"待开票"，账期内所有订单状态变为"已核对"，页面自动刷新显示新状态
11. **Given** 在确认弹窗，**When** 点击取消，**Then** 关闭弹窗，账单状态不变
12. **Given** 账单确认成功后，**When** 查看页面，**Then** 流程步骤高亮从"确认账单"移动到"提交发票"，操作按钮区域更新为"一键开票"和"撤销确认"

---

### User Story 3 - 配置账单明细展示维度 (Priority: P2)

企业财务人员可以根据财务管理需求，自定义配置账单汇总明细的展示维度，按照业务线、法人实体、支付账户、部门等维度进行多层级数据拆分展示。

**Why this priority**: 不同企业的财务管理维度不同，灵活的明细配置能够满足个性化需求，提升用户体验，但不影响基本的账单查看和确认功能。

**Independent Test**: 用户在账单汇总页点击"明细设置"，配置拆分维度后，明细数据按照配置的维度进行多层级展示。

**Acceptance Scenarios**:

1. **Given** 在账单汇总tab，**When** 点击"明细设置"，**Then** 唤起设置弹窗
2. **Given** 在设置弹窗，**When** 选择拆分维度，**Then** 可以从"业务线"、"法人实体"、"支付账户"、"部门"中选择多个维度
3. **Given** 在设置弹窗，**When** 保存配置，**Then** 账单汇总的明细数据按照配置的维度进行多层级展示
4. **Given** 明细已配置多维度，**When** 查看明细，**Then** 数据以树形结构展示，可以展开/收起各层级

---

### User Story 4 - 配置和导出对账单 (Priority: P2)

企业财务人员可以配置对账单显示和导出的字段，并将账单明细导出为Excel或PDF格式，用于线下审核和存档。

**Why this priority**: 导出功能是企业财务工作的常见需求，但不是在线处理的必要功能，可以在基本流程完成后实现。

**Independent Test**: 用户在账单明细tab配置显示字段，然后导出Excel和PDF，文件包含配置的字段数据。

**Acceptance Scenarios**:

1. **Given** 在账单明细tab，**When** 点击"对账单字段配置"，**Then** 弹出配置窗口
2. **Given** 在配置窗口，**When** 选择字段，**Then** 可以分别配置：显示的对账单字段、导出Excel的字段、导出PDF的字段（最多20个）
3. **Given** 在账单明细tab，**When** 点击"导出Excel"，**Then** 下载包含配置字段的Excel文件
4. **Given** 在账单明细tab，**When** 点击"导出PDF"，**Then** 下载包含配置字段（最多20个）的PDF文件

---

### User Story 5 - 提交发票申请（含完整开票数据） (Priority: P1)

账单确认后，企业财务人员进入开票流程，系统在原有tab左侧新增"开票汇总"tab，必须展示完整的应开票金额统计、发票明细、发票抬头信息等所有必要数据。点击"一键开票"后进入开票页面，填写完整的开票信息并提交申请。

**Why this priority**: 开票是结算流程的核心环节，直接关系到企业能否及时获得发票进行报销和入账。开票数据的完整性和准确性直接影响发票的开具成功率，必须作为高优先级实现。

**Independent Test**: 用户确认账单后，查看完整的开票汇总信息（包括各类型发票的金额统计、发票抬头列表、历史开票记录等），点击一键开票，填写完整的开票信息并提交，账单进入"开票中"状态，所有开票数据正确保存。

**Acceptance Scenarios**:

1. **Given** 账单状态为"待开票"，**When** 进入详情页，**Then** 显示三个tab：开票汇总、账单汇总、账单明细，默认激活"开票汇总"tab
2. **Given** 在开票汇总tab，**When** 查看顶部统计数据，**Then** 显示完整的开票金额统计：
   - 应开票金额总计（等于账单总金额）
   - 已开票金额（初始为0）
   - 还可提交金额（初始等于应开票金额）
   - 统计数据以醒目的卡片形式展示，还可提交金额高亮显示
3. **Given** 在开票汇总tab，**When** 查看发票明细表格，**Then** 按发票种类和发票摘要拆分显示每类发票的详细信息：
   - **发票种类**：增值税普票、增值税专票、机票电子行程单、火车票电子行程单（根据实际业务数据动态显示）
   - **发票摘要**：再按发票摘要进一步拆分（如"机票住宿费"、"保险费"等）
   - **应开票金额**：该类型发票应开具的金额
   - **已开票金额**：该类型发票已开具的金额（初始为0）
   - **还可提交金额**：该类型发票还可以申请的金额
   - 每行数据必须显示对应的订单数量，方便财务人员核对
4. **Given** 在开票汇总tab底部，**When** 查看发票抬头信息区域，**Then** 显示企业已配置的发票抬头列表：
   - 发票抬头名称
   - 纳税人识别号
   - 地址电话
   - 开户行及账号
   - 默认标记（如有）
   - 支持选择用于本次开票的抬头
5. **Given** 在账单详情页（待开票状态），**When** 查看操作按钮区域，**Then** 显示"一键开票"和"撤销确认"两个按钮，按钮下方显示提示文字"请确认开票金额无误后点击一键开票"
6. **Given** 在账单详情页，**When** 点击"撤销确认"，**Then** 弹出二次确认窗口，显示"撤销确认后账单状态将回退到待确认，是否继续？"
7. **Given** 在撤销确认窗口，**When** 点击确认，**Then** 账单状态回退到"待确认"，所有订单状态也回退到未核对，页面自动返回到账单汇总tab，流程步骤高亮回退
8. **Given** 在账单详情页，**When** 点击"一键开票"，**Then** 页面切换到开票页（替换原有的tab区域），显示页面标题"填写开票信息"和返回按钮
9. **Given** 在开票页，**When** 查看开票信息表，**Then** 显示按发票种类和发票摘要拆分的开票行，每行包含完整字段：
   - **发票种类**：下拉选择（增值税普票/增值税专票/机票电子行程单/火车票电子行程单）
   - **发票摘要**：显示分类摘要（如"机票住宿费"）
   - **开票金额**：自动计算显示，不可编辑
   - **发票抬头**：下拉选择已配置的发票抬头，或点击"新增抬头"
   - **接收人信息**：包含收件人姓名、电话、邮箱、收货地址
   - **单位**：发票单位（如"元"）
   - **数量**：最大5位数，默认为1
   - 每行右侧显示该行对应的订单数量，方便核对
10. **Given** 在开票页，**When** 选择发票抬头，**Then** 自动填充对应的纳税人识别号、地址电话、开户行账号等信息，并显示在表单下方供确认
11. **Given** 在开票页，**When** 点击"拆分汇总"按钮，**Then** 弹出配置窗口，可以按业务线、法人实体、支付账户、部门等维度拆分开票信息，拆分后每个维度生成独立的开票行
12. **Given** 在开票页，**When** 填写完所有必填开票信息，**Then** "申请开票"按钮高亮可点击，按钮上方显示"共X行开票信息，总金额Y元"
13. **Given** 在开票页，**When** 有未填写的必填字段，**Then** "申请开票"按钮置灰不可点击，未填写字段标红提示
14. **Given** 在开票页底部，**When** 点击"申请开票"按钮，**Then** 弹出最终确认窗口，显示开票信息汇总（发票种类、金额、抬头、接收人），要求用户再次确认
15. **Given** 在最终确认窗口，**When** 点击确认，**Then** 提交开票申请，显示提交中加载状态，成功后账单状态变更为"开票中"，页面返回开票汇总tab，显示成功提示
16. **Given** 开票申请提交成功后，**When** 查看开票汇总tab，**Then** 已开票金额更新为已提交的金额，还可提交金额相应减少，下方显示开票申请记录列表，包含刚提交的申请记录及其处理状态

---

### User Story 6 - 查看和管理已开发票 (Priority: P2)

账单进入"开票中"或"待付款"状态后，企业财务人员可以在开票汇总tab查看已申请的发票记录，对发票进行下载、红冲、换开等操作。

**Why this priority**: 发票管理是开票后的必要功能，但相比开票申请本身，优先级稍低，可以在开票功能完成后实现。

**Independent Test**: 用户在开票汇总tab查看发票申请记录列表，选择发票进行下载、红冲或换开操作。

**Acceptance Scenarios**:

1. **Given** 账单状态为"开票中"或"待付款"，**When** 进入开票汇总tab，**Then** 显示开票申请记录列表
2. **Given** 在开票申请记录列表，**When** 查看列表，**Then** 每条记录可以勾选，并显示发票类型、内容、金额、抬头、提交人、申请时间、状态
3. **Given** 在开票申请记录列表，**When** 点击操作栏的"下载"，**Then** 下载该发票文件
4. **Given** 在开票申请记录列表，**When** 点击操作栏的"红冲"，**Then** 弹出确认窗口，确认后执行红冲操作
5. **Given** 在开票申请记录列表，**When** 点击操作栏的"换开"，**Then** 弹出窗口要求输入新的发票抬头和税号，确认后执行换开操作

---

### User Story 7 - 配置拆分汇总维度 (Priority: P3)

在开票页面，用户可以配置"拆分汇总"功能，按照不同维度（业务线、法人实体、支付账户、部门）对开票信息进行拆分展示，方便按需开具不同维度的发票。

**Why this priority**: 这是高级功能，主要服务于有复杂财务管理需求的大型企业，对于基本开票流程非必需，可以作为后续优化功能。

**Independent Test**: 用户在开票页点击"拆分汇总"，配置拆分维度后，开票信息表按照配置的维度进行分组展示。

**Acceptance Scenarios**:

1. **Given** 在开票页，**When** 点击"拆分汇总"按钮，**Then** 弹出配置窗口
2. **Given** 在配置窗口，**When** 设置字段一和字段二，**Then** 可以从"业务线"、"法人实体"、"支付账户"、"部门"中选择，两个字段不能重复
3. **Given** 在配置窗口，**When** 保存配置，**Then** 开票信息表按照配置的维度进行分组展示
4. **Given** 开票信息已拆分，**When** 查看开票信息表，**Then** 数据按照配置的维度分组，每组显示汇总金额和明细

---

### Edge Cases

- **空数据场景**: 当企业在选定的时间范围内没有任何账单包时，列表页显示空状态提示"该时间范围内暂无账单数据"
- **订单号查询无结果**: 当输入的订单号在所有账单包中都不存在时，显示提示"未找到该订单号对应的账单"
- **日期范围超限**: 当用户选择的日期范围超过180天时，系统自动调整为最近180天并提示用户
- **账单确认中断**: 如果用户在确认账单过程中网络中断，系统应回滚状态，保持账单为"待确认"状态
- **开票申请提交失败**: 如果开票申请提交时后台服务异常，应显示明确的错误提示，允许用户重新提交，不应改变账单状态
- **撤销确认限制**: 如果账单已经进入"开票中"状态（后台已开始开票处理），不应允许撤销确认
- **业务线tab动态显示**: 如果某个业务线在当前账期没有任何订单数据，该业务线的tab应完全隐藏，不显示空tab
- **批量查询输入格式**: 批量查询功能应支持多种输入格式（换行分隔、逗号分隔、空格分隔），并能智能识别和去重
- **PDF字段限制**: 当用户尝试为PDF配置超过20个字段时，系统应阻止保存并提示"PDF最多支持20个字段"
- **发票数量输入验证**: 开票信息表中的数量字段应限制为最大5位数，输入超出范围时实时提示
- **换开发票税号验证**: 换开发票时，输入的税号应进行格式验证，不符合国家税号规则的应提示错误
- **拆分维度配置冲突**: 当用户在拆分汇总配置中选择了相同的字段一和字段二时，应阻止保存并提示"字段不能重复"
- **明细设置级联影响**: 在账单汇总配置明细设置后，如果有未确认的订单数据更新，明细数据应自动刷新
- **开票信息表验证**: 提交开票申请前，应验证所有必填字段（发票抬头、接收人信息）都已填写，否则阻止提交并高亮未填写字段

## Requirements *(mandatory)*

### Functional Requirements

#### 系统入口与导航

- **FR-001**: 系统MUST移除侧边栏菜单，用户登录后直接进入账单列表页作为唯一入口
- **FR-002**: 系统MUST移除"开票批次"相关的独立菜单和页面
- **FR-003**: 账单列表页MUST作为系统的默认首页和唯一导航入口

#### 账单列表页

- **FR-004**: 账单列表页MUST提供结算时间范围筛选，默认显示最近一个月
- **FR-005**: 结算时间范围筛选MUST限制最多选择180天
- **FR-006**: 账单列表页MUST提供账单状态筛选，状态包括：待确认、调账中、待开票、待付款、已结清
- **FR-007**: 账单列表页MUST提供订单号搜索功能
- **FR-008**: 订单号搜索MUST支持直接跳转到对应账单包的详情页，并自动在该账单包的订单明细中执行搜索
- **FR-009**: 账单列表MUST显示以下字段：结算周期、状态、账单总计、待开票金额
- **FR-010**: 账单列表的每条记录MUST提供"查看详情"操作按钮
- **FR-011**: 系统MUST在列表为空时显示友好的空状态提示

#### 账单详情页 - 流程状态

- **FR-012**: 账单详情页MUST显示4步流程状态：确认账单 → 提交发票 → 付款 → 已结清
- **FR-013**: 系统MUST移除原有的"开始对账"步骤，流程从"确认账单"开始
- **FR-014**: 系统MUST根据当前账单状态高亮显示对应的流程步骤

#### 账单详情页 - 确认账单状态（待确认）

- **FR-015**: 账单处于"待确认"状态时，MUST显示两个tab：账单汇总、账单明细
- **FR-016**: 系统MUST移除"预存机票"和"预存酒店"的独立tab页
- **FR-017**: 账单汇总tab MUST显示完整的账单汇总信息，包括：本期账单消费金额合计、按业务线拆分的金额统计、订单数量统计、结算周期时间范围、企业基本信息
- **FR-017-1**: 账单汇总的金额统计MUST按业务线拆分，显示机票金额、酒店金额、火车票金额、用车金额及各自占比
- **FR-017-2**: 账单汇总MUST显示订单数量统计，包括总订单数、各业务线订单数、平均订单金额
- **FR-017-3**: 账单汇总MUST显示企业基本信息，包括企业名称、账户类型（预存/授信）、信用额度或账户余额
- **FR-018**: 账单汇总tab MUST提供"明细设置"功能按钮
- **FR-019**: 明细设置MUST支持按"业务线"、"法人实体"、"支付账户"、"部门"进行多维度配置
- **FR-020**: 账单汇总的明细数据MUST根据明细设置配置，以多层级树形结构展示各维度数据，每个层级显示该维度的汇总金额和订单数量
- **FR-021**: 账单明细tab MUST按业务线（机票、酒店、火车票、用车）显示各业务线的明细数据
- **FR-022**: 业务线tab MUST动态显示，只显示有数据的业务线，无数据的业务线应隐藏
- **FR-023**: 账单明细tab MUST提供搜索功能，支持按订单号、核对状态、入住人/出行人、法人实体条件筛选
- **FR-023-1**: 账单明细tab的订单列表MUST显示完整的订单字段，包括通用字段（订单号、预订日期、出行日期、预订人、出行人、支付金额、核对状态）和业务特有字段
- **FR-023-2**: 机票订单MUST显示特有字段：航班号、起飞时间、航线、舱位等级、电子客票号
- **FR-023-3**: 酒店订单MUST显示特有字段：酒店名称、入住日期、离店日期、房间数量、房型、入住人姓名
- **FR-023-4**: 火车票订单MUST显示特有字段：车次、出发时间、线路、座位等级、乘车人身份证号后四位
- **FR-023-5**: 用车订单MUST显示特有字段：用车时间、起点、终点、车型、行驶里程
- **FR-023-6**: 所有订单MUST显示财务字段：法人实体、支付账户、成本中心、项目部门、费用类型
- **FR-024**: 账单明细tab MUST支持批量查询功能，能够同时查询多个订单号或其他条件
- **FR-025**: 批量查询MUST支持换行、逗号、空格等多种分隔符，并能智能去重
- **FR-025-1**: 账单明细tab底部MUST显示当前查看/筛选的订单汇总统计：总订单数、总金额、各支付方式金额小计
- **FR-026**: 账单明细tab MUST提供"导出Excel"功能
- **FR-027**: 账单明细tab MUST提供"导出PDF"功能
- **FR-028**: 账单明细tab MUST提供"对账单字段配置"功能
- **FR-029**: 对账单字段配置MUST支持分别配置：显示的对账单字段、导出Excel的字段、导出PDF的字段
- **FR-030**: PDF字段配置MUST限制最多配置20个字段，受宽度限制
- **FR-031**: 系统MUST在PDF字段超过20个时阻止保存并提示用户
- **FR-032**: 账单详情页（待确认状态）MUST显示"确认账单"按钮
- **FR-033**: 点击确认账单按钮MUST唤起二次确认弹窗，显示"是否确认X~Y账单金额无误"，并展示关键金额数据（总金额、各业务线金额）
- **FR-034**: 确认账单操作MUST变更账单包状态为"待开票"
- **FR-035**: 确认账单操作MUST将账期内所有对账单状态变更为"已核对"
- **FR-035-1**: 确认账单操作MUST记录确认时间、确认人信息
- **FR-035-2**: 确认账单成功后，页面MUST自动刷新并高亮显示新状态，流程步骤自动移动到"提交发票"
- **FR-036**: 取消确认操作MUST关闭弹窗，不改变任何状态

#### 账单详情页 - 提交发票状态（待开票）

- **FR-037**: 账单处于"待开票"状态时，MUST在原有两个tab左侧新增"开票汇总"tab，并默认激活该tab
- **FR-038**: 系统MUST显示三个tab：开票汇总、账单汇总、账单明细，tab顺序从左到右
- **FR-039**: 开票汇总tab顶部MUST以醒目的卡片形式显示完整的开票金额统计：应开票金额总计、已开票金额、还可提交金额，还可提交金额以高亮颜色显示
- **FR-039-1**: 应开票金额MUST等于账单总金额，初始状态已开票金额为0，还可提交金额等于应开票金额
- **FR-039-2**: 开票金额统计卡片MUST实时更新，当提交开票申请后，已开票金额增加，还可提交金额相应减少
- **FR-040**: 开票汇总tab MUST显示发票明细表格
- **FR-041**: 发票明细表格MUST按发票种类（增值税普票、增值税专票、机票电子行程单、火车票电子行程单）和发票摘要进行拆分，根据实际业务数据动态显示
- **FR-042**: 发票明细表格的每一行MUST显示完整字段：发票种类、发票摘要、应开票金额、已开票金额、还可提交金额、对应订单数量
- **FR-042-1**: 发票种类字段MUST根据业务类型自动分类（机票→机票电子行程单，酒店/火车票/用车→增值税普票或专票）
- **FR-042-2**: 发票摘要字段MUST进一步按费用类型拆分（如"机票住宿费"、"保险费"、"交通费"等）
- **FR-043**: 开票汇总tab底部MUST显示企业已配置的发票抬头列表，包括：抬头名称、纳税人识别号、地址电话、开户行账号、默认标记，支持选择用于本次开票的抬头
- **FR-043-1**: 发票抬头列表MUST支持新增抬头功能，点击"新增发票抬头"可以在弹窗中填写完整的抬头信息
- **FR-044**: 账单详情页（待开票状态）MUST在原确认账单按钮位置显示两个按钮："一键开票"和"撤销确认"，按钮下方显示操作提示文字
- **FR-045**: 撤销确认功能MUST在点击后弹出二次确认窗口，显示"撤销确认后账单状态将回退到待确认，是否继续？"
- **FR-046**: 撤销确认操作MUST将账单状态回退到"待确认"
- **FR-047**: 撤销确认操作MUST将所有相关数据（订单状态、确认时间、确认人）同步回退
- **FR-047-1**: 撤销确认成功后，页面MUST自动切换到账单汇总tab，流程步骤高亮回退到"确认账单"
- **FR-048**: 系统MUST在账单已进入"开票中"状态后禁止撤销确认操作，按钮置灰并显示提示"账单已进入开票流程，无法撤销"

#### 开票页

- **FR-049**: 点击"一键开票"按钮MUST跳转到开票页
- **FR-050**: 开票页MUST替换原有的tab和tab页内容区域，显示页面标题"填写开票信息"和返回按钮
- **FR-051**: 开票页MUST显示开票信息表，表格上方显示说明文字"请为每类发票填写完整的开票信息"
- **FR-052**: 开票信息表MUST按发票种类和发票摘要拆分显示开票行，每行对应一个开票维度
- **FR-053**: 开票信息表的每一行MUST包含完整字段：
   - 发票种类（下拉选择：增值税普票/增值税专票/机票电子行程单/火车票电子行程单）
   - 发票摘要（显示分类摘要，如"机票住宿费"）
   - 开票金额（自动计算，不可编辑，高亮显示）
   - 发票抬头（下拉选择已配置抬头，或点击"新增抬头"）
   - 接收人信息（姓名、电话、邮箱、收货地址，标记必填）
   - 单位（默认"元"）
   - 数量（输入框，最大5位数，默认1）
   - 对应订单数（只读显示，方便核对）
- **FR-053-1**: 发票抬头下拉MUST显示已配置抬头的完整信息，包括抬头名称和纳税人识别号，选中后自动填充地址电话和开户行账号
- **FR-053-2**: 接收人信息的各字段MUST有格式验证：电话号码格式、邮箱格式、地址长度限制
- **FR-054**: 系统MUST验证数量字段不超过5位数，超出时实时提示"数量最大为99999"
- **FR-055**: 开票页顶部MUST提供"拆分汇总"功能按钮，点击可配置拆分维度
- **FR-056**: 拆分汇总配置MUST支持设置字段一和字段二，从"业务线"、"法人实体"、"支付账户"、"部门"中选择
- **FR-057**: 拆分汇总配置MUST验证字段一和字段二不能重复，重复时阻止保存并提示"字段不能重复"
- **FR-058**: 开票信息表MUST根据拆分汇总配置按维度进行分组展示，每个分组显示汇总金额和订单数，可以展开查看明细
- **FR-059**: 拆分汇总后，系统MUST自动生成多行开票信息，每行对应一个维度组合，用户可以为每行独立配置发票抬头和接收人
- **FR-060**: 开票页底部MUST提供"申请开票"按钮，按钮上方显示开票信息汇总："共X行开票信息，总金额Y元"
- **FR-061**: 系统MUST在所有必填字段填写完整后，"申请开票"按钮才可点击（高亮显示），否则按钮置灰
- **FR-062**: 系统MUST实时验证必填字段，未填写的字段以红色边框标识，字段下方显示错误提示
- **FR-063**: 点击"申请开票"按钮MUST弹出最终确认窗口，显示开票信息汇总表：
   - 发票种类及数量
   - 总金额
   - 发票抬头列表
   - 接收人信息汇总
   - 提示文字"请确认开票信息无误，提交后将开始开票流程"
- **FR-064**: 最终确认窗口MUST提供"确认提交"和"返回修改"两个按钮
- **FR-065**: 点击"确认提交"MUST提交开票申请，显示提交中加载状态（禁止重复提交）
- **FR-066**: 提交开票申请成功后MUST将账单状态变更为"开票中"，记录申请时间和申请人
- **FR-067**: 提交成功后页面MUST自动返回开票汇总tab，显示成功提示"开票申请已提交，请等待开票完成"，开票金额统计自动更新
- **FR-068**: 系统MUST在开票申请提交失败时保持原状态，不改变账单状态，显示明确的错误提示（如"网络异常，请重试"），允许重新提交

#### 发票管理

- **FR-064**: 账单处于"开票中"或"待付款"状态时，开票汇总tab MUST显示开票申请记录列表
- **FR-065**: 开票申请记录列表MUST支持多选
- **FR-066**: 开票申请记录列表MUST显示每条记录的操作列，提供：下载、红冲、换开操作
- **FR-067**: 下载操作MUST允许用户下载对应的发票文件
- **FR-068**: 红冲操作MUST在点击后弹出二次确认窗口
- **FR-069**: 换开操作MUST要求用户提供新的发票抬头和税号
- **FR-070**: 换开操作MUST验证税号格式，不符合税号规则时提示错误

### Key Entities

- **账单包（Bill Package）**: 代表一个结算周期的账单汇总，包含结算周期、状态（待确认/调账中/待开票/待付款/已结清）、账单总计金额、待开票金额、确认时间等信息

- **订单明细（Order Detail）**: 代表账单包内的具体订单数据，包含订单号、业务类型（机票/酒店/火车票/用车）、核对状态、入住人/乘机人、法人实体、支付金额、预订日期、出行日期等信息

- **开票信息（Invoice Information）**: 代表一条待开票的记录，包含发票种类（增值税普票/专票/电子行程单）、发票摘要、开票金额、发票抬头、接收人信息、单位、数量等信息

- **发票记录（Invoice Record）**: 代表已申请的发票，包含发票类型、发票内容、开票金额、发票抬头、提交人、申请时间、状态（处理中/已完成/已红冲）、发票文件等信息

- **明细配置（Detail Configuration）**: 代表用户自定义的明细展示配置，包含配置的维度（业务线/法人实体/支付账户/部门）、维度顺序、是否启用等信息

- **字段配置（Field Configuration）**: 代表用户自定义的对账单字段配置，分别包含显示字段列表、Excel导出字段列表、PDF导出字段列表（最多20个）

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### 性能指标

- **SC-001**: 用户登录后0.5秒内加载并显示账单列表页，无侧边栏延迟
- **SC-002**: 用户可在3秒内完成账单列表的任意筛选操作（日期/状态/订单号）
- **SC-003**: 用户点击"查看详情"后1秒内加载并显示账单详情页完整数据（包括汇总统计和订单列表）
- **SC-004**: 账单详情页的各业务线订单明细在2秒内完成渲染，支持最多10,000条订单无明显卡顿
- **SC-005**: 账单状态从"待确认"切换到"待开票"后，页面在1秒内完成刷新并显示新状态的所有数据
- **SC-006**: 开票页的开票信息表在2秒内加载完成，包括所有预填充数据（发票种类、金额、默认抬头等）
- **SC-007**: 导出Excel和PDF功能在10秒内完成文件生成和下载，包含用户配置的所有字段
- **SC-008**: 批量查询功能支持一次查询最多500个订单号，结果在5秒内返回并高亮显示
- **SC-009**: 明细设置配置保存后，明细数据在2秒内按照新配置重新渲染为多层级树形结构
- **SC-010**: 拆分汇总配置保存后，开票信息表在2秒内按照新配置重新分组展示，自动生成对应的开票行

#### 流程完整性指标

- **SC-011**: 用户可在5分钟内完成一个账单包的查看、确认全流程（从列表页→查看汇总和明细→确认账单→状态更新）
- **SC-012**: 用户可在10分钟内完成一个账单包的开票申请全流程（从确认账单→查看开票汇总→填写开票信息→提交申请→状态更新）
- **SC-013**: 账单确认成功率达到99.9%，确认后所有订单状态正确同步变更为"已核对"
- **SC-014**: 撤销确认操作成功率达到100%，撤销后账单状态和订单状态完全回退到确认前状态
- **SC-015**: 开票申请提交成功率达到99.5%，提交成功后账单状态正确变更为"开票中"，开票金额统计准确更新
- **SC-016**: 开票申请提交失败时，100%的情况下保持原账单状态不变，显示明确错误提示，允许重新提交

#### 数据展示完整性指标

- **SC-017**: 账单汇总tab必须展示100%的必要数据字段：总金额、各业务线金额及占比、订单数量统计、企业信息、结算周期
- **SC-018**: 账单明细tab的订单列表必须展示100%的业务必要字段：通用字段（7个）+ 业务特有字段（5个）+ 财务字段（5个），确保财务人员可以完整核对
- **SC-019**: 开票汇总tab必须展示100%的开票必要数据：应开票金额、已开票金额、还可提交金额、发票明细表（按种类和摘要拆分）、发票抬头列表
- **SC-020**: 开票信息表的每一行必须包含100%的开票必要字段（8个字段），且必填字段标记清晰，验证实时生效
- **SC-021**: 所有金额统计数据的准确率达到100%，与订单明细的汇总计算结果完全一致，误差为0

#### 用户体验指标

- **SC-022**: 90%的用户能在第一次使用时，无需查看帮助文档即可完成账单确认操作
- **SC-023**: 95%的用户能在第一次使用时，无需查看帮助文档即可完成开票申请操作
- **SC-024**: 用户界面简化后，用户完成账单处理的平均时间减少30%（从约15分钟减少到10分钟以内）
- **SC-025**: 因UI复杂度导致的用户操作错误减少50%（从约10次/百单减少到5次/百单）
- **SC-026**: 用户对数据展示完整性的满意度达到90%以上（通过用户调研问卷评估）
- **SC-027**: 因数据字段缺失导致的客服咨询减少70%（相比旧版本）

#### 数据准确性指标

- **SC-028**: 账单状态流转的准确性达到100%，从"待确认"→"待开票"→"开票中"的每一步流转都正确记录时间和操作人
- **SC-029**: 订单状态同步的准确性达到100%，确认账单后所有订单状态正确变更，撤销确认后完全回退
- **SC-030**: 开票金额计算的准确性达到100%，应开票金额=已开票金额+还可提交金额，误差为0元

## Assumptions *(mandatory)*

### 系统架构假设

1. 用户已完成身份认证，系统能够识别用户所属的企业
2. 后台系统能够提供账单包、订单明细、开票信息等数据的完整API接口，包括所有必要的数据字段
3. 账单包的结算周期由后台系统自动生成，前端仅负责展示
4. 账单状态的流转由前端触发，后台验证并持久化，状态变更后所有关联数据同步更新
5. 系统不支持同时处理多个账单包的批量操作，每次只能操作一个账单包

### 数据完整性假设

6. 后台API返回的账单数据必须包含完整的汇总统计（总金额、各业务线金额、订单数量等）
7. 后台API返回的订单明细数据必须包含所有业务必要字段（通用字段、业务特有字段、财务字段）
8. 订单号在系统中是唯一的，订单号搜索跳转不会出现重复订单的情况
9. 业务线tab的动态显示基于当前账期是否有该业务线的订单数据，不考虑历史数据
10. 开票金额的计算规则由后台定义并保证准确性，前端仅负责展示计算结果
11. 所有金额数据均保留两位小数，汇总计算时后台已处理精度问题

### 业务规则假设

12. 发票种类的枚举（增值税普票/专票/电子行程单）由系统预定义，不可由用户自定义
13. 发票种类自动分类规则：机票订单→机票电子行程单，其他业务线→增值税普票或专票
14. 明细设置和字段配置保存后立即生效，无需刷新页面，配置数据持久化到后台用户配置表
15. 批量查询的分隔符识别规则：优先按换行分隔，其次按逗号，最后按空格，自动去重
16. PDF导出的字段限制为20个是基于A4纸横向打印的宽度限制，Excel导出无字段数量限制

### 状态流转假设

17. 撤销确认操作仅在账单处于"待开票"状态时允许，进入"开票中"后不可撤销
18. 确认账单操作必须将账期内所有订单状态同步变更为"已核对"，这是原子操作，要么全部成功，要么全部失败
19. 撤销确认操作必须将所有相关数据（账单状态、订单状态、确认时间、确认人）完全回退，保证数据一致性
20. 开票申请提交后，后台异步处理开票逻辑，前端仅改变账单状态为"开票中"，不等待实际开票完成

### 发票管理假设

21. 企业已在系统中配置了至少一个发票抬头，未配置抬头的企业需要在开票前先新增抬头
22. 发票抬头包含完整信息：抬头名称、纳税人识别号、地址电话、开户行及账号
23. 发票下载功能假设后台已生成发票文件，前端提供下载链接
24. 换开发票时，新的发票抬头和税号需要通过后台验证（包括税号真实性验证），前端仅做格式验证
25. 接收人信息的格式验证规则：手机号11位数字，邮箱符合标准邮箱格式，地址不超过100字符

### 数据展示假设

26. 账单汇总的明细拆分维度配置对所有账单包通用，用户修改配置后对所有账单生效
27. 对账单字段配置分为显示字段、Excel导出字段、PDF导出字段三组，三组配置独立
28. 拆分汇总功能的维度配置仅对当前开票申请生效，不影响账单汇总的明细展示配置
29. 所有时间字段按照"YYYY-MM-DD HH:mm:ss"格式展示，日期字段按照"YYYY-MM-DD"格式展示
30. 金额字段统一显示为"¥X,XXX.XX"格式，千分位分隔，保留两位小数

## Out of Scope

以下功能**不在**本次重构范围内：

1. **调账功能**: "调账中"状态的详细业务逻辑和操作界面（等待后续调账功能上线）
2. **付款功能**: "付款"步骤的具体支付流程和界面（本次仅更新流程状态展示）
3. **用户权限管理**: 不涉及用户角色、权限配置等功能
4. **企业信息管理**: 不涉及企业基本信息、发票抬头管理等功能
5. **系统设置**: 不涉及全局系统配置、参数设置等功能
6. **数据统计分析**: 不涉及账单数据的图表分析、趋势展示等功能
7. **消息通知**: 不涉及账单状态变更的站内信、邮件、短信通知等功能
8. **审批流程**: 不涉及账单确认、开票申请的多级审批流程
9. **移动端适配**: 本次重构仅针对PC端Web界面，不考虑移动端响应式设计
10. **多语言支持**: 界面仅支持中文简体，不涉及国际化
11. **历史版本对比**: 不支持查看账单的历史修改记录和版本对比
12. **批量操作**: 不支持同时确认、开票多个账单包
13. **自定义报表**: 不支持用户自定义生成各种维度的账单报表
14. **API集成**: 不提供开放API供第三方系统集成调用

## Dependencies

1. **后台API服务**: 依赖后台系统提供账单列表、账单详情、订单明细、开票信息等数据接口
2. **身份认证服务**: 依赖统一的用户认证系统，获取当前登录用户和企业信息
3. **文件生成服务**: 依赖后台服务生成Excel和PDF文件
4. **开票服务**: 依赖后台开票系统处理开票申请、红冲、换开等操作
5. **状态同步机制**: 依赖后台系统在状态变更时正确同步所有相关数据（如确认账单时同步订单状态）
6. **数据一致性保障**: 依赖后台系统保证账单金额、开票金额等统计数据的一致性和准确性

## Risks

1. **数据量性能风险**: 如果单个账单包包含超大量订单明细（如>10,000条），可能导致前端渲染性能下降
   - **缓解措施**: 实施分页加载、虚拟滚动等技术优化

2. **状态同步失败风险**: 确认账单或提交开票时，如果后台处理失败但前端已更新状态，可能导致数据不一致
   - **缓解措施**: 采用乐观锁机制，前端操作前先锁定账单，后台处理完成后才释放

3. **并发操作风险**: 多个用户同时操作同一个账单包时，可能出现冲突
   - **缓解措施**: 后台实施锁机制，同一时间只允许一个用户编辑账单

4. **浏览器兼容性风险**: 不同浏览器对某些UI组件的渲染可能存在差异
   - **缓解措施**: 明确支持的浏览器范围（Chrome 90+, Edge 90+, Firefox 88+），在不支持的浏览器上显示升级提示

5. **文件导出超时风险**: 大量数据导出时，可能因后台处理时间过长导致请求超时
   - **缓解措施**: 采用异步导出机制，大文件导出时显示进度，完成后提供下载链接

6. **配置丢失风险**: 用户配置的明细设置、字段配置等可能因浏览器清理缓存而丢失
   - **缓解措施**: 配置数据保存到后台用户配置表，而非仅保存在浏览器本地

7. **批量查询性能风险**: 批量查询大量订单号时，可能导致后台数据库查询压力过大
   - **缓解措施**: 限制单次批量查询数量（最多500个），对频繁查询的用户进行限流

8. **开票信息验证遗漏风险**: 如果前端验证规则与后台不一致，可能导致用户提交后才发现错误
   - **缓解措施**: 前后端共享验证规则配置，保持一致性

9. **用户体验适应风险**: 移除侧边栏菜单后，部分习惯旧版界面的用户可能不适应
   - **缓解措施**: 提供新功能引导提示，记录用户反馈并快速迭代优化

10. **跨账期数据查询风险**: 按订单号跳转时，如果订单跨多个账期，可能跳转到错误的账单包
    - **缓解措施**: 明确订单号跳转规则（跳转到最新账期的账单包），并在界面提示该订单所在的账期

## Notes

### UI简化设计理念

本次重构的核心思想是"化繁为简"，通过移除冗余的导航层级，让用户能够更直接、高效地完成账单处理任务。具体体现在：

1. **单一入口**: 移除侧边栏菜单，以账单列表页作为唯一入口，减少用户的认知负担
2. **流程优化**: 简化账单状态流转，从5步精简为4步，去除"开始对账"的冗余步骤
3. **Tab结构简化**: 移除"预存机票"、"预存酒店"等预设tab，改为动态显示有数据的业务线tab
4. **操作集中**: 将开票相关的所有操作集中在开票页，避免跨页面跳转

### 明细配置的灵活性

明细设置和拆分汇总是为了满足不同企业的个性化财务管理需求而设计的。通过灵活的维度配置（业务线、法人实体、支付账户、部门），用户可以：

- 按照企业内部的成本中心进行账单拆分
- 按照不同法人实体分别开票
- 按照部门进行费用分摊统计

这些配置应该保存为用户级别的个性化配置，并在所有账单包中保持一致，除非用户主动修改。

### 开票流程的状态机设计

账单的状态流转遵循严格的状态机模型：

```
待确认 → 待开票 → 开票中 → 待付款 → 已结清
   ↑        ↓
   └────────┘ (撤销确认)
```

- **待确认 → 待开票**: 用户点击"确认账单"触发
- **待开票 → 待确认**: 用户点击"撤销确认"触发（仅在未进入开票中时允许）
- **待开票 → 开票中**: 用户点击"申请开票"触发
- **开票中 → 待付款**: 后台开票服务完成开票后自动触发
- **待付款 → 已结清**: 后台财务系统确认收款后自动触发

状态流转必须保证原子性和一致性，避免中间状态导致的数据混乱。

### 字段配置的持久化策略

对账单字段配置涉及三个维度：显示字段、Excel导出字段、PDF导出字段。这三者应该：

- **独立配置**: 用户可以分别配置三种场景的字段，互不影响
- **持久化保存**: 配置保存到后台数据库，不受浏览器缓存清理影响
- **默认值**: 首次使用时提供合理的默认字段配置，覆盖常用场景
- **版本管理**: 字段配置应支持版本管理，当系统新增字段时能够通知用户更新配置

### 性能优化考虑

由于账单明细可能包含大量订单数据，需要在多个层面进行性能优化：

1. **前端优化**: 
   - 使用虚拟滚动技术渲染大列表
   - 对订单数据进行分页加载
   - 缓存已加载的数据，避免重复请求

2. **后台优化**:
   - 对订单查询接口进行索引优化
   - 实施数据分片策略
   - 使用缓存层（Redis）加速热点数据访问

3. **导出优化**:
   - 大文件导出采用异步任务队列
   - 限制单次导出的数据量
   - 提供导出进度提示

### 用户体验细节

1. **加载状态**: 所有涉及后台请求的操作都应显示加载状态（Spinner或进度条），避免用户误以为系统卡顿
2. **错误提示**: 所有错误提示应使用用户友好的语言，避免暴露技术细节（如"网络错误"而非"500 Internal Server Error"）
3. **操作反馈**: 所有状态变更操作（确认账单、申请开票等）应提供即时的成功反馈
4. **数据保护**: 在用户填写开票信息但未提交时，如果误关闭页面，应提示保存或自动暂存数据
5. **引导提示**: 对于首次使用的用户，在关键操作点提供引导提示（如"确认账单"、"一键开票"按钮）

### 后续迭代方向

虽然本次重构不包含以下功能，但可以考虑在后续版本中实现：

1. **智能推荐**: 根据历史开票记录，智能推荐发票抬头和接收人信息
2. **批量操作**: 支持同时处理多个账单包的批量确认、批量开票
3. **数据可视化**: 在账单列表页提供图表展示账单趋势、金额分布等
4. **快捷键支持**: 为常用操作（确认账单、导出Excel等）提供键盘快捷键
5. **离线支持**: 使用Service Worker技术，支持在网络不稳定时离线查看已加载的账单数据
6. **移动端优化**: 开发响应式设计或独立的移动端界面
7. **语音操作**: 集成语音识别，支持语音输入订单号查询等操作
