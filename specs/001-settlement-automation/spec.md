# Feature Specification: 企业自动化结算平台

**Feature Branch**: `001-settlement-automation`  
**Created**: 2026-01-15  
**Status**: Draft  
**Input**: 用户描述：构建一个类似携程的自动化结算平台，核心目标是实现企业对账、开票、付款等环节的线上化与自动化，从而显著降低结算团队的人力投入。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 企业用户查看并核对账单 (Priority: P1)

企业财务人员每月需要核对公司在平台上的消费账单，确认所有订单明细准确无误后才能进入开票流程。

**Why this priority**: 这是整个结算流程的起点，没有账单核对，后续的开票和付款都无法进行。这是最核心的MVP功能，能够立即帮助企业建立对账数据的信任基础。

**Independent Test**: 可以通过企业用户登录系统，查看当月账单包，核对机票/火车票/酒店等业务线的订单明细，并完成"已核对"确认操作来独立测试。即使没有后续开票功能，这个功能本身也能帮助企业完成线上对账。

**Acceptance Scenarios**:

1. **Given** 企业用户已登录且有当月消费记录, **When** 用户访问账单管理页面, **Then** 系统展示当月账单包，包含各业务线（机票、火车票、酒店）的消费金额汇总和账单状态（待对账/已核对/已结清）
2. **Given** 企业用户打开某个"待对账"账单包, **When** 用户查看账单明细, **Then** 系统按业务线分类展示所有订单，包括订单号、乘客/入住人、金额、日期等关键信息
3. **Given** 企业用户核对完某条账单明细, **When** 用户勾选该明细为"已核对", **Then** 系统标记该明细状态为已核对，并允许用户取消核对
4. **Given** 企业用户已核对完所有明细, **When** 用户点击"全部确认", **Then** 系统将账单包状态更新为"对账完成"
5. **Given** 企业用户需要筛选特定订单, **When** 用户按时间范围或员工姓名搜索, **Then** 系统展示符合条件的订单明细

---

### User Story 2 - 企业用户申请并下载发票 (Priority: P1)

企业财务人员在完成对账后，需要申请开具发票并下载发票文件用于报销和财务记账。

**Why this priority**: 开票是企业结算的核心诉求，直接影响企业的财务流程。与对账功能一起构成了最小可用的闭环，能立即为企业创造价值。

**Independent Test**: 可以通过企业用户在"对账完成"的账单包中申请发票，填写或确认发票信息，等待系统开票完成后下载发票PDF文件来独立测试。这个功能能独立验证开票流程的完整性。

**Acceptance Scenarios**:

1. **Given** 企业用户的账单包状态为"对账完成", **When** 用户点击"申请发票", **Then** 系统展示发票信息填写页面，包括发票抬头、收货人、联系方式等字段
2. **Given** 企业用户填写完发票信息, **When** 用户提交申请, **Then** 系统生成开票批次，将请求推送至后台开票队列，并展示"开票中"状态
3. **Given** 系统已完成开票, **When** 用户返回账单包页面, **Then** 系统展示应开发票金额、已开发票金额的汇总，以及各发票类型（增值税普通发票、专用发票、电子行程单）的分类统计
4. **Given** 企业用户需要下载发票, **When** 用户点击"下载发票", **Then** 系统提供所有发票文件的批量下载功能
5. **Given** 发票开具失败, **When** 用户查看账单包状态, **Then** 系统展示失败原因并提供联系结算人员的入口

---

### User Story 3 - 企业用户导出账单数据 (Priority: P2)

企业财务人员需要将账单明细导出为Excel和PDF格式，用于内部审批和存档。

**Why this priority**: 数据导出是企业财务流程的重要辅助功能，能显著提升用户体验，但不影响核心对账和开票流程的运行。

**Independent Test**: 可以通过企业用户选择已核对的账单包，点击导出功能，验证生成的Excel文件按业务线分Sheet展示，以及生成带企业公章的PDF汇总文件来独立测试。

**Acceptance Scenarios**:

1. **Given** 企业用户查看某个账单包, **When** 用户点击"导出Excel", **Then** 系统生成Excel文件，其中机票、火车票、酒店订单分别在不同的Sheet中
2. **Given** 企业用户需要PDF格式账单, **When** 用户点击"导出PDF", **Then** 系统生成带企业公章的PDF账单汇总文件
3. **Given** 企业用户筛选了特定订单, **When** 用户点击导出, **Then** 系统仅导出筛选后的订单数据

---

### User Story 4 - 预存企业用户调整账单数据 (Priority: P3)

预存企业的财务人员在核对账单时，发现部分订单的成本中心、项目部门或发票抬头需要调整，可以在线修改这些字段。

**Why this priority**: 这是针对预存企业的增值功能，能够减少人工干预，但不影响基础流程运行。授信企业暂不开放此功能以规避资金风险。

**Independent Test**: 可以通过预存企业用户登录后，在账单明细中选择订单，修改成本中心、项目部门或发票抬头字段，验证修改成功并在后续流程中生效来独立测试。

**Acceptance Scenarios**:

1. **Given** 预存企业用户查看账单明细, **When** 用户选中多个订单并点击"批量修改", **Then** 系统展示可修改字段（成本中心、项目部门、发票抬头）的编辑界面
2. **Given** 用户修改了订单字段, **When** 用户保存修改, **Then** 系统更新订单数据并在导出文件和发票中体现修改
3. **Given** 授信企业用户尝试修改订单, **When** 用户点击"批量修改", **Then** 系统提示"该功能仅对预存企业开放，请联系结算人员"

---

### User Story 5 - 结算人员处理开票异常 (Priority: P2)

结算人员需要在后台查看开票失败的订单，手动补充数据或触发重试，确保企业最终能获得完整的发票交付物。

**Why this priority**: 异常处理是保障系统可靠性的关键，但不影响正常流程的运行。在灰度阶段必须具备，以应对各种边缘情况。

**Independent Test**: 可以通过结算人员登录后台，查看开票失败列表，选择某个失败订单，手动补充电子行程单数据或触发重新开票，验证企业用户最终能下载到正确发票来独立测试。

**Acceptance Scenarios**:

1. **Given** 某个开票请求失败, **When** 结算人员查看后台开票队列, **Then** 系统展示失败订单列表，包括失败原因和企业联系信息
2. **Given** 电子行程单无法在线开具, **When** 结算人员手动上传行程单文件, **Then** 系统关联该文件至对应订单，企业用户可正常下载
3. **Given** 发票需要红冲重开, **When** 结算人员触发红冲流程, **Then** 系统执行红冲并自动发起重新开票请求
4. **Given** 企业用户通过快捷通道联系结算人员, **When** 结算人员接收到请求, **Then** 系统展示该企业的完整账单和开票状态，便于快速定位问题

---

### User Story 6 - 企业用户完成付款并查看结清状态 (Priority: P3)

企业财务人员在收到发票后，将款项支付至平台对公账户，平台后台确认收款后，账单包状态更新为"已结清"。

**Why this priority**: 付款是结算流程的最后一环，但在MVP阶段可以通过线下确认或后台手动操作完成，不需要复杂的在线支付集成。

**Independent Test**: 可以通过企业用户在系统中查看付款账户信息，线下完成转账，结算人员在后台确认收款后，验证账单包状态更新为"已结清"来独立测试。

**Acceptance Scenarios**:

1. **Given** 企业用户已下载发票, **When** 用户查看账单包详情, **Then** 系统展示平台对公账户信息和应付金额
2. **Given** 企业用户已完成线下付款, **When** 结算人员在后台确认收款, **Then** 系统将账单包状态更新为"已结清"
3. **Given** 账单包已结清, **When** 企业用户查看历史账单, **Then** 系统展示该账单包的完整闭环记录（对账时间、开票时间、付款时间）

---

### User Story 7 - 结算人员管理企业账单总览 (Priority: P1)

结算人员需要在MOS后台系统中查看和管理所有企业的账单总览，监控账单生成、开票进度和异常情况。

**Why this priority**: 这是后台管理的核心功能，结算人员需要全局视角监控所有企业的结算进度，及时发现和处理异常，保证compMOS前台系统的正常运行。

**Independent Test**: 可以通过结算人员登录MOS后台，在"账单总览"页面筛选企业、查看账单状态、监控开票进度、导出账单数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 结算人员登录MOS后台, **When** 访问"账单总览"页面, **Then** 系统展示所有企业的账单列表，包括账单编号、企业名称、账单日、账单周期、出账方式（支付时间/出行时间）、账单状态、用户可见性等信息
2. **Given** 结算人员需要查看特定企业的账单, **When** 按企业名称、账单编号、结算人员、出账方式等条件筛选, **Then** 系统展示符合条件的账单列表
3. **Given** 结算人员需要监控账单开票进度, **When** 查看账单状态列, **Then** 系统按"未开票"、"开票中"、"可整理"等标签区分不同状态
4. **Given** 某个账单需要调整用户可见性, **When** 结算人员修改"用户可见性"字段, **Then** 系统控制该账单是否在compMOS前台展示给企业用户
5. **Given** 结算人员需要批量导出账单, **When** 选中多个账单并点击"账单导出", **Then** 系统生成包含所有订单明细的Excel文件
6. **Given** 结算人员需要查看后结账单, **When** 查看企业标签, **Then** 系统标记后结企业并展示关联的后结账单编号

---

### User Story 8 - 结算人员管理开票申请流程 (Priority: P1)

结算人员需要在MOS后台系统中查看和处理所有企业的开票申请，包括批次拆分、开票执行、红冲管理等操作。

**Why this priority**: 开票申请管理是结算业务的核心环节，结算人员需要监控开票批次状态、处理开票失败、执行红冲操作，确保企业最终获得正确的发票交付物。

**Independent Test**: 可以通过结算人员在MOS后台"开票申请列表"中查看开票批次、监控开票状态、处理开票失败、执行红冲操作来独立测试。

**Acceptance Scenarios**:

1. **Given** 结算人员登录MOS后台, **When** 访问"开票申请列表"页面, **Then** 系统展示所有开票批次，包括批次号、产品类型、企业名称、开票抬头、纳税人识别号、开票类型（普票/专票/行程单）、开票状态、邮寄状态等信息
2. **Given** 结算人员需要筛选特定开票申请, **When** 按产品类型、企业名称、开票抬头、批次号、开票状态等条件筛选, **Then** 系统展示符合条件的开票批次
3. **Given** 结算人员需要查看开票金额明细, **When** 点击"开票金额明细导出", **Then** 系统按开票金额类型（机票票面+改签手续费、票面、退票手续费、服务费、保险费等）拆分展示
4. **Given** 某个开票批次失败, **When** 结算人员查看失败原因, **Then** 系统展示详细的错误信息和建议处理方式
5. **Given** 企业申请发票红冲, **When** 结算人员在后台执行红冲操作, **Then** 系统根据发票类型（增值税发票/火车票/行程单）应用不同的红冲规则
6. **Given** 需要批量红冲, **When** 结算人员上传红冲Excel文件, **Then** 系统按对账单ID、原子ID或最原始票号批量执行红冲

---

### User Story 9 - 结算人员管理企业对账单明细 (Priority: P2)

结算人员需要在MOS后台查看企业的详细对账单，包括订单明细、出行信息、成本归属、供应商信息等，用于核对和问题排查。

**Why this priority**: 详细的对账单查询能力是结算人员处理企业咨询、核对数据差异、排查问题的重要工具，虽然不影响核心流程，但对提升运营效率至关重要。

**Independent Test**: 可以通过结算人员在MOS后台"企业对账单"页面查询特定企业的订单明细，按多维度筛选，验证数据准确性来独立测试。

**Acceptance Scenarios**:

1. **Given** 结算人员登录MOS后台, **When** 访问"企业对账单"页面, **Then** 系统展示订单明细列表，包括产品类型、企业名称、订单号、预订人、出行人、费用承担项目（成本中心）、成本归属部门、法人实体、支付时间、订单时间、出行时间、供应商等信息
2. **Given** 结算人员需要查询特定订单, **When** 按订单号、预订人姓名、出行人姓名、成本中心、供应商、出行时间等多维度筛选, **Then** 系统展示符合条件的订单明细
3. **Given** 结算人员需要区分出行状态, **When** 筛选"出行状态"字段, **Then** 系统区分"已出行"和"未出行"的订单
4. **Given** 企业用户咨询某笔订单的详情, **When** 结算人员通过订单号查询, **Then** 系统展示该订单的完整信息，包括支付金额、出行时间、成本归属、发票信息等
5. **Given** 需要导出对账单数据, **When** 结算人员点击"导出", **Then** 系统生成Excel文件，包含筛选后的所有订单明细

---

### User Story 10 - 结算人员管理账户和后结账单 (Priority: P2)

结算人员需要在MOS后台管理企业的预存账户和授信账户，生成和管理后结账单，监控企业的账单和还款情况。

**Why this priority**: 账户管理和后结账单是区分预存企业和授信企业的关键，影响企业的付款方式和结算周期，需要结算人员精细管理以控制资金风险。

**Independent Test**: 可以通过结算人员在MOS后台"账单管理"页面查看后结账单列表、重新生成账单、导出账单、查看关联账单来独立测试。

**Acceptance Scenarios**:

1. **Given** 结算人员登录MOS后台, **When** 访问"账单管理(新)"页面, **Then** 系统展示后结账单列表，包括后结账单号、企业名称、账户名称、账户类型（预存/授信）、账单维度（支付时间/出行时间）、账单周期、生成时间、账单金额、关联账单等信息
2. **Given** 结算人员需要筛选特定账单, **When** 按企业名称、易快报企业ID、后结账单编号、关联账单等条件筛选, **Then** 系统展示符合条件的后结账单
3. **Given** 某个后结账单需要重新生成, **When** 结算人员点击"重新生成", **Then** 系统重新计算账单金额并生成新的账单文件
4. **Given** 结算人员需要导出单个账单, **When** 点击"导出", **Then** 系统生成该账单的Excel明细文件
5. **Given** 结算人员需要查看关联账单详情, **When** 点击"关联账单"链接, **Then** 系统跳转至"账单总览"页面并展示该账单的详细信息
6. **Given** 结算人员需要监控账单生成时间, **When** 查看"生成时间"列, **Then** 系统展示账单的具体生成时间戳

---

### Edge Cases

- **当企业用户取消核对后又重新确认时**，系统应正确记录最新的核对状态，不影响后续开票流程
- **当电子行程单无法在线开具时**，系统应自动标记为异常，通知结算人员手动处理，并在前端展示"开票处理中"状态
- **当增值税发票和电子行程单混开时**，系统应按发票类型分类展示，避免企业混淆
- **当企业申请红冲火车票但已超过换开次数限制时**，系统应提示"该车票已无法红冲，请联系结算人员"
- **当同一账单包内部分订单开票成功、部分失败时**，系统应允许企业下载已成功的发票，同时展示失败订单的处理进度
- **当授信企业用户尝试访问调账功能时**，系统应明确提示权限限制并提供结算人员联系方式
- **当企业用户在对账过程中新增了订单消费时**，系统应按订单实际发生时间归属账期，当月发生的订单计入当月账单包，但如果当月账单包已进入"开票中"或之后状态，则新订单自动计入下期账单包
- **当月账单包为空（无消费记录）时**，系统应展示空状态页面，说明当月无需对账
- **当企业同时有多个财务人员操作同一账单包时**，系统应处理并发修改冲突，避免数据不一致

## Requirements *(mandatory)*

### Functional Requirements

#### 账单包管理
- **FR-001**: 系统必须每月自动生成企业账单包，按业务线（机票、火车票、酒店）划分消费数据
- **FR-002**: 系统必须支持账单包状态管理，包括"待对账"、"已核对"、"对账完成"、"开票中"、"已结清"等状态
- **FR-003**: 系统必须展示账单包的总体消费金额汇总和各业务线的明细汇总
- **FR-004**: 系统必须支持按时间范围筛选账单包
- **FR-005**: 系统必须支持按员工姓名搜索订单明细

#### 对账功能
- **FR-006**: 企业用户必须能够查看账单包内的所有订单明细，包括订单号、乘客/入住人、金额、日期、业务线等信息
- **FR-007**: 企业用户必须能够逐项勾选订单为"已核对"状态
- **FR-008**: 企业用户必须能够取消已核对状态，支持修正误操作
- **FR-009**: 系统必须在所有订单被核对后，允许用户点击"全部确认"，将账单包状态更新为"对账完成"
- **FR-010**: 系统必须记录每次核对操作的时间和操作人

#### 开票功能
- **FR-011**: 系统必须在账单包"对账完成"后，允许企业用户申请发票
- **FR-012**: 系统必须支持企业用户填写或确认发票抬头、收货人、联系方式等开票信息
- **FR-013**: 系统必须支持三种发票类型：增值税普通发票、增值税专用发票、电子行程单
- **FR-014**: 系统必须在用户提交开票申请后，生成开票批次并推送至后台开票队列
- **FR-015**: 系统必须实时展示"应开发票金额"和"已开发票金额"的汇总
- **FR-016**: 系统必须按发票类型分类展示开票统计（普通发票、专用发票、行程单）
- **FR-017**: 系统必须支持企业用户批量下载所有已开发票文件
- **FR-018**: 系统必须在开票失败时，展示失败原因并提供结算人员联系入口

#### 红冲与重开
- **FR-019**: 系统必须支持增值税发票的随时红冲
- **FR-020**: 系统必须限制火车票仅支持一次换开
- **FR-021**: 系统必须在电子行程单无法在线红冲时，标记为异常并通知结算人员
- **FR-022**: 系统必须在红冲成功后，允许用户重新申请开票

#### 数据导出
- **FR-023**: 系统必须支持将账单明细导出为Excel格式，机票、火车票、酒店订单分别在不同Sheet中
- **FR-024**: 系统必须支持生成带企业公章的PDF账单汇总文件
- **FR-025**: 系统必须支持导出筛选后的订单数据

#### 调账功能（仅预存企业）
- **FR-026**: 系统必须允许预存企业用户批量修改订单的成本中心、项目部门、发票抬头字段
- **FR-027**: 系统必须禁止授信企业用户访问调账功能，并提示联系结算人员
- **FR-028**: 系统必须在订单被修改后，确保修改在导出文件和发票中生效

#### 用户权限
- **FR-029**: 系统必须区分预存企业用户和授信企业用户两种角色
- **FR-030**: 系统必须为结算人员提供后台管理权限，包括查看所有企业账单、处理异常、手动补充数据
- **FR-031**: 系统必须为每个企业提供快捷联系结算人员的通道

#### 付款与结清
- **FR-032**: 系统必须展示平台对公账户信息和企业应付金额
- **FR-033**: 系统必须允许结算人员在后台确认企业付款，并将账单包状态更新为"已结清"
- **FR-034**: 系统必须记录账单包的完整生命周期（对账时间、开票时间、付款时间）

#### 异常处理
- **FR-035**: 系统必须为结算人员提供开票失败订单列表，包含失败原因和企业联系信息
- **FR-036**: 系统必须允许结算人员手动上传电子行程单文件，并关联至对应订单
- **FR-037**: 系统必须允许结算人员触发红冲和重新开票流程
- **FR-038**: 系统必须建立标准化操作流程（SOP）文档，指导结算人员处理各类异常

#### 后台管理功能（MOS系统）
- **FR-042**: MOS后台系统必须提供"账单总览"功能，展示所有企业的账单列表，支持按企业名称、账单编号、结算人员、出账方式、账单状态、用户可见性、对账结算单版本等多维度筛选
- **FR-043**: MOS后台系统必须支持账单状态标签，包括"未开票"、"开票中"、"可整理"等，便于结算人员快速识别账单状态
- **FR-044**: MOS后台系统必须支持控制账单的"用户可见性"，决定账单是否在compMOS前台展示给企业用户
- **FR-045**: MOS后台系统必须支持账单批量导出和列表导出功能，生成包含订单明细的Excel文件
- **FR-046**: MOS后台系统必须区分后结企业，展示后结账单编号，并支持查看后结账单依赖的出账结果
- **FR-047**: MOS后台系统必须提供"开票申请列表"功能，展示所有开票批次的状态、进度和详情
- **FR-048**: MOS后台系统必须支持开票申请的多维度筛选，包括产品类型、企业名称、开票抬头、纳税人识别号、开票类型、开票状态、邮寄状态、订单号、票号、批次号等
- **FR-049**: MOS后台系统必须支持"开票申请导出"和"开票金额明细导出"，按开票金额类型（机票票面+改签手续费、票面、退票手续费、服务费、保险费、税额加成、活动/红包等）拆分展示
- **FR-050**: MOS后台系统必须提供"企业对账单"功能，支持按产品类型、企业名称、订单号、预订人、出行人、费用承担项目、成本归属部门、法人实体、供应商、出行状态、支付时间、订单时间、出行时间等多维度查询订单明细
- **FR-051**: MOS后台系统必须区分出行状态，标识订单是否已出行，便于结算人员核对和问题排查
- **FR-052**: MOS后台系统必须提供"账单管理(新)"功能，管理后结账单，支持重新生成账单、导出账单、查看关联账单等操作
- **FR-053**: MOS后台系统必须区分账户类型（预存/授信），并根据账户类型应用不同的结算规则和权限控制
- **FR-054**: MOS后台系统必须支持账单维度设置，包括"支付时间"和"出行时间"两种出账方式，影响账单周期的计算
- **FR-055**: MOS后台系统必须提供红冲批量操作功能，支持按对账单ID、原子ID、最原始票号三种数据范围批量红冲
- **FR-056**: MOS后台系统必须区分线上红冲和线下红冲，并提供红冲日志查询和结果下载功能
- **FR-057**: MOS后台系统必须记录结算人员信息，包括"生成时结算人员"和"当前结算人员"，支持按结算人员筛选账单
- **FR-058**: MOS后台系统必须提供"对账结算单版本"管理，区分"经典版"和"新版"，支持不同版本的数据格式和业务规则
- **FR-059**: MOS后台系统必须支持监控"是否推送对账结算"状态，标识账单是否已推送到compMOS前台系统

#### 系统集成与数据同步
- **FR-060**: compMOS前台系统必须从MOS后台系统实时或准实时获取账单数据，确保企业用户看到的账单状态与MOS后台一致
- **FR-061**: compMOS前台系统的开票申请必须推送至MOS后台的开票队列，由MOS统一调度和执行开票任务
- **FR-062**: 系统必须确保账单状态变更（如"对账完成"、"开票中"、"已结清"）在compMOS和MOS之间双向同步
- **FR-063**: 系统必须确保企业用户在compMOS前台的调账操作（仅预存企业）实时同步至MOS后台，并更新订单明细数据
- **FR-064**: 系统必须确保MOS后台修改的账单"用户可见性"立即影响compMOS前台的账单展示
- **FR-065**: 系统必须记录所有跨系统操作的审计日志，包括操作人、操作时间、操作内容、操作来源（compMOS/MOS）

#### 一期范围限制
- **FR-066**: 系统一期仅覆盖机票、火车票、酒店业务线，不包含企业购、通用订单、餐饮、用车、保险等其他业务线
- **FR-067**: 系统一期不包含复杂的数据权限隔离功能，企业内部所有财务人员共享相同的数据访问权限
- **FR-068**: 系统必须支持灰度上线，先对少量企业开放，逐步扩大覆盖范围

### Key Entities

#### 核心业务实体

- **账单包（Bill Package / Statement）**: 按月、按企业生成的账单集合
  - **基础属性**: 账单编号（billNo）、企业ID（companyId）、企业名称（companyName）、账单日（billDate）、账单周期（billRange）、总金额（totalAmount）
  - **状态属性**: 账单状态（billStatus：出账中/校验中/出账成功/出账失败）、用户可见性（visible：可见/不可见）、整理状态（organizeType：未开票/开票中/可整理）
  - **时间属性**: 生成时间（createTime）、对账时间（confirmTime）、开票时间（invoiceTime）、付款时间（paymentTime）、出行时间范围（travelStartTime - travelEndTime）
  - **配置属性**: 出账方式（billType：支付时间/出行时间）、对账结算单版本（settleVersion：经典版/新版）、是否推送对账结算（pushSettle）
  - **关联属性**: 关联的后结账单编号（postBillNo）、后结账单依赖状态（postBillDepended）、结算人员ID（生成时settleId，当前curSettleId）
  - **企业属性**: 企业属性标识（companyAttribute：是否后结企业）、易快报企业ID（appId）

- **订单明细（Order Detail / Fee Atom）**: 单笔消费记录的原子数据
  - **订单信息**: 订单号（orderNo）、原始订单号（endorseNo）、业务线类型（proType：001酒店/002机票/003火车/004用车/005餐饮/007通用/008保险）
  - **出行信息**: 出行人姓名（travelerName）、预订人姓名（bookerName）、出行状态（haveTraveled：是/否）、出发时间（departTime）、到达时间（arriveTime）、出行时间（travelTime）
  - **财务信息**: 支付金额（payAmount）、支付时间（payTime）、订单时间（orderTime）、费用承担项目/成本中心（costCenter）、成本归属部门（costUnderDep）、法人实体（legalEntity）
  - **发票信息**: 发票抬头（invoiceTitle）、纳税人识别号（taxpayerIdentificationNumber）、核对状态（checkStatus）
  - **供应商信息**: 供应商/产品提供方（productProvider）、渠道产品类型（channelProductName）、出行类别（category）
  - **扩展信息**: 集团名称（groupName，适用于集团托管酒店）、原子ID（atomId）、票号（ticketNo）

- **发票（Invoice）**: 开票记录和发票文件信息
  - **发票基础**: 发票号（invoiceNo）、发票类型（invoiceType：001专票/002普票/003行程单/004火车票）、开票类目（invoiceCategory）
  - **开票主体**: 购方抬头（buyInvoiceHeader）、购方税号（buyTaxNumber）、销方信息（sellerInfo）
  - **金额信息**: 发票金额（invoiceAmount）、开票金额类型（invoiceAmountType：机票票面+改签手续费/票面/改签手续费/退票手续费/票根费/服务费/保险费/税额加成/活动红包）
  - **状态信息**: 开票状态（invoiceStatus）、邮寄状态（shippingStatus）、红冲状态（redReversalStatus）
  - **时间信息**: 开具时间（invoiceTime）、邮寄时间（shippingTime）、红冲时间（redReversalTime）
  - **文件信息**: 发票文件URL（invoiceFileUrl）、文件下载链接（downloadLink）
  - **关联信息**: 关联订单列表（orderList）、原始发票号（originalInvoiceNo，红冲场景）

- **开票批次（Invoice Batch）**: 一次开票申请的集合，用于批量开票管理
  - **批次信息**: 批次号（batchId）、批次创建时间（createTime）、批次状态（batchStatus：待拆分/拆分中/拆分完成/拆分失败/开票中/开票完成/开票失败）
  - **申请信息**: 操作内容（operateType：普通开票/火车票换开）、开票范围（scope：指定企业+日期区间/指定数据/账单编号）
  - **企业信息**: 企业ID列表（companyIds）、企业名称（companyName）、易快报企业ID（companyAppId）
  - **时间范围**: 日期口径（type：支付时间/出行时间/支付时间+出行时间）、时间区间（date/payDate/travelDate）
  - **发票配置**: 购方抬头类型（defaultInvoiceheaderType：所有账单均开同一抬头/按照账单标识开具）、抬头选择方式（titleType：读取企业配置/自行填写/使用企业唯一抬头）
  - **收货信息**: 收货人（receiverName）、收货电话（receiverPhone）、收货地址（receiverAddress）
  - **数据范围**: 数据类型（dataScope：按对账单ID/按原子ID/按最原始票号）、上传文件URL（fileUrl）、账单编号（billNo）
  - **拆分结果**: 预计生成发票数量（expectedInvoiceCount）、实际生成发票数量（actualInvoiceCount）、拆分耗时（splitDuration）

- **后结账单（Post-Bill）**: 授信企业的后结算账单，用于管理还款和资金回笼
  - **账单信息**: 后结账单号（postBillNo）、企业ID（companyId）、账户ID（accountId）、账户名称（accountName）、账户类型（accountType：1预存/2授信）
  - **金额信息**: 账单金额（billAmount）、已还款金额（paidAmount）、待还款金额（unpaidAmount）
  - **时间信息**: 生成时间（createDateStr）、账单周期（billCycle）、还款日（repayDay）
  - **关联信息**: 关联的财务账单编号（financeBillNo）、账单维度（outBillType：1出行时间/2支付时间）
  - **操作信息**: 是否可重新生成（canRegenerate）、是否可导出（canExport）、是否可重新发送邮件（canResendEmail）

#### 管理实体

- **企业（Enterprise / Company）**: 使用平台的企业客户
  - **基础信息**: 企业ID（companyId）、企业名称（companyName）、统一社会信用代码（creditCode）、易快报企业ID（appId）
  - **账户信息**: 账户类型（预存/授信）、账户ID列表（accountIds）、账户余额（balance）、授信额度（creditLimit）
  - **结算配置**: 结算人员ID（settleManagerId）、结算周期（settleCycle）、账单日（billDate）、还款日（repayDay）
  - **开票配置**: 默认发票抬头（defaultInvoiceHeader）、默认纳税人识别号（defaultTaxpayerNumber）、收货地址列表（addressList）
  - **业务属性**: 是否后结企业（companyAttribute）、开票规则维护状态（invoiceRuleStatus）、对账结算单版本（settleVersion）
  - **联系信息**: 主联系人（mainContact）、联系电话（phone）、联系邮箱（email）

- **用户（User）**: 企业财务人员或结算人员
  - **基础信息**: 用户ID（userId）、用户名（username）、姓名（name）、角色（role：企业用户/结算人员）
  - **权限信息**: 所属企业（companyId）、权限范围（permissions）、数据权限（dataScope）
  - **登录信息**: 登录方式（loginType：邮箱/SSO）、最后登录时间（lastLoginTime）、登录状态（loginStatus）

- **结算人员（Settlement Manager）**: MOS后台的运营人员
  - **基础信息**: 结算人员ID（settleManagerId）、姓名（name）、工号（employeeNo）
  - **负责范围**: 负责企业列表（companyIds）、负责业务线（businessTypes）
  - **操作权限**: 账单管理权限（billManagementPermission）、开票管理权限（invoiceManagementPermission）、调账权限（adjustmentPermission）、红冲权限（redReversalPermission）
  - **工作信息**: 当前负责账单数（currentBillCount）、待处理异常数（pendingExceptionCount）

#### 辅助实体

- **异常记录（Exception Log）**: 开票失败、红冲失败等异常情况的记录
  - **异常信息**: 异常ID（exceptionId）、异常类型（exceptionType：开票失败/红冲失败/数据同步失败）、异常等级（level：高/中/低）
  - **关联信息**: 关联订单（orderNo）、关联账单（billNo）、关联批次（batchId）、关联企业（companyId）
  - **详细信息**: 失败原因（failReason）、错误代码（errorCode）、错误堆栈（stackTrace）
  - **处理信息**: 处理状态（processStatus：待处理/处理中/已处理/已忽略）、处理人（processorId）、处理时间（processTime）、处理备注（processRemark）
  - **重试信息**: 重试次数（retryCount）、下次重试时间（nextRetryTime）、是否可重试（canRetry）

- **操作日志（Operation Log）**: 记录所有关键操作的审计日志
  - **操作信息**: 日志ID（logId）、操作类型（operationType：查看/新增/修改/删除/导出/审批）、操作对象（objectType：账单/发票/订单/企业）
  - **操作人**: 操作人ID（operatorId）、操作人姓名（operatorName）、操作人角色（operatorRole）、操作来源（source：compMOS/MOS）
  - **操作内容**: 操作前数据（beforeData）、操作后数据（afterData）、变更字段（changedFields）、操作描述（description）
  - **时间信息**: 操作时间（operateTime）、操作耗时（duration）
  - **关联信息**: 关联对象ID（objectId）、关联企业（companyId）、关联账单（billNo）

- **红冲批次（Red Reversal Batch）**: 批量红冲操作的记录
  - **批次信息**: 批次ID（batchId）、批次状态（batchStatus）、创建时间（createTime）、完成时间（finishTime）
  - **数据范围**: 数据范围类型（dataScope：按对账单ID/按原子ID/按最原始票号）、上传文件URL（fileUrl）、模板类型（templateType）
  - **执行信息**: 是否线下红冲（isOffline：0线上/1线下）、总数量（totalCount）、成功数量（successCount）、失败数量（failCount）
  - **结果信息**: 结果文件URL（resultFileUrl）、失败原因汇总（failReasonSummary）
  - **操作人**: 申请人ID（applicantId）、申请人姓名（applicantName）

- **地址信息（Address）**: 企业收货地址信息
  - **地址详情**: 地址ID（addressId）、收货人（receiverName）、联系电话（phone）、详细地址（address）、省份（province）、城市（city）、区县（district）
  - **地址类型**: 地址类型（addressType：发票邮寄地址/对账单邮寄地址）、是否默认（isDefault）
  - **关联信息**: 所属企业（companyId）、创建时间（createTime）、更新时间（updateTime）

## System Architecture & Integration *(mandatory)*

### 系统架构关系

本项目包含两个独立但紧密集成的系统：

1. **compMOS（企业自动化结算平台）**: 面向企业客户的前台系统
   - **用户群体**: 企业财务人员
   - **核心功能**: 账单查看与核对、开票申请、发票下载、数据导出、预存企业调账
   - **技术特点**: 轻量级Web应用，注重用户体验和操作便捷性
   - **访问方式**: 企业用户通过浏览器访问，支持企业SSO登录

2. **MOS（合思商城运营系统）**: 面向运营人员的后台管理系统
   - **用户群体**: 结算人员、运营人员、管理员
   - **核心功能**: 账单总览、开票申请管理、对账单查询、账户管理、异常处理、红冲管理、数据导出、权限管理
   - **技术特点**: 功能丰富的管理后台，支持复杂的数据查询和批量操作
   - **访问方式**: 内部运营人员登录，权限严格控制

### 系统集成点

#### 1. 账单数据同步
- **方向**: MOS → compMOS
- **同步内容**: 账单包基础信息、账单状态、订单明细、各业务线汇总数据
- **同步方式**: 准实时推送或定时轮询（取决于账单生成和状态变更频率）
- **关键字段**: 账单编号、企业ID、账单状态、用户可见性、总金额、各业务线明细
- **数据流程**:
  1. MOS后台每月自动生成账单包
  2. MOS将账单数据推送至compMOS数据库或通过API提供查询
  3. compMOS读取"用户可见性=可见"的账单展示给企业用户
  4. 企业用户在compMOS查看账单明细，数据来源于MOS的订单明细表

#### 2. 开票申请提交
- **方向**: compMOS → MOS
- **提交内容**: 开票批次信息、发票抬头、收货地址、关联账单列表、开票类型
- **提交方式**: 企业用户在compMOS提交开票申请后，系统通过API或消息队列将申请推送至MOS
- **关键字段**: 批次号、企业ID、账单编号列表、购方抬头、购方税号、收货人信息、开票类型
- **数据流程**:
  1. 企业用户在compMOS填写开票信息并提交
  2. compMOS生成开票批次记录，状态为"待拆分"
  3. compMOS通过API调用将开票申请推送至MOS开票队列
  4. MOS接收请求后进行批次拆分和开票任务调度
  5. MOS开票完成后，通过回调或状态同步通知compMOS
  6. compMOS更新开票批次状态为"开票完成"，企业用户可下载发票

#### 3. 账单状态同步
- **方向**: compMOS ↔ MOS（双向）
- **同步场景**:
  - **compMOS → MOS**: 企业用户完成对账确认（"对账完成"状态），compMOS通知MOS更新账单状态
  - **MOS → compMOS**: MOS后台修改账单状态（如"开票中"、"已结清"），需同步至compMOS
- **同步方式**: 状态变更事件触发API调用或消息队列推送
- **关键字段**: 账单编号、账单状态、变更时间、操作人
- **数据流程**:
  1. 企业用户在compMOS点击"全部确认"，账单状态变更为"对账完成"
  2. compMOS调用MOS API通知状态变更
  3. MOS更新账单状态并记录操作日志
  4. 结算人员在MOS后台确认收款，账单状态变更为"已结清"
  5. MOS推送状态变更事件至compMOS
  6. compMOS更新本地账单状态，企业用户刷新页面后看到最新状态

#### 4. 调账数据同步（仅预存企业）
- **方向**: compMOS → MOS
- **同步内容**: 订单字段修改（成本中心、项目部门、发票抬头）
- **同步方式**: 实时API调用
- **关键字段**: 订单号、修改字段、修改前值、修改后值、操作人、操作时间
- **数据流程**:
  1. 预存企业用户在compMOS选择订单并批量修改字段
  2. compMOS校验用户权限（仅预存企业）
  3. compMOS调用MOS API提交调账请求
  4. MOS验证数据合法性并更新订单明细
  5. MOS返回调账结果给compMOS
  6. compMOS刷新订单明细展示最新数据
  7. 调账记录体现在后续的账单导出和发票开具中

#### 5. 发票文件存储与下载
- **方向**: MOS → compMOS → 企业用户
- **存储方式**: MOS调用第三方开票服务商后，将发票PDF文件上传至云存储（如OSS），生成下载链接
- **访问方式**: compMOS从MOS获取发票文件下载链接，企业用户通过compMOS下载
- **关键字段**: 发票号、文件URL、文件类型（PDF/OFD）、文件大小、下载有效期
- **数据流程**:
  1. MOS开票完成后，发票PDF文件存储在云存储服务
  2. MOS将发票记录（包含文件URL）写入数据库
  3. compMOS通过API查询企业的发票列表，获取文件URL
  4. 企业用户在compMOS点击"下载发票"
  5. compMOS生成带鉴权的临时下载链接（如带签名的OSS URL）
  6. 企业用户浏览器直接从云存储下载文件，或通过compMOS服务端代理下载

#### 6. 异常通知与处理
- **方向**: MOS → compMOS
- **通知场景**: 开票失败、红冲失败、数据同步失败等异常
- **通知方式**: MOS通过消息队列或Webhook通知compMOS，compMOS在前台展示异常信息并提供联系入口
- **关键字段**: 异常类型、异常原因、关联订单、关联批次、建议处理方式、结算人员联系方式
- **数据流程**:
  1. MOS开票任务执行失败，记录异常日志
  2. MOS推送异常通知至compMOS
  3. compMOS接收异常通知，更新开票批次状态为"开票失败"
  4. 企业用户刷新compMOS页面，看到"开票失败"提示和失败原因
  5. 企业用户点击"联系结算人员"，compMOS展示结算人员联系方式
  6. 结算人员在MOS后台查看异常详情并手动处理
  7. 处理完成后，MOS通知compMOS更新状态

#### 7. 用户权限验证
- **方向**: compMOS → MOS
- **验证场景**: 企业用户登录、调账权限校验、操作权限校验
- **验证方式**: compMOS调用MOS的权限验证API
- **关键字段**: 用户ID、企业ID、账户类型（预存/授信）、操作类型
- **数据流程**:
  1. 企业用户通过SSO登录compMOS
  2. compMOS调用MOS API验证用户身份和所属企业
  3. MOS返回用户权限信息（账户类型、可访问账单列表等）
  4. compMOS根据权限信息控制功能访问（如授信企业隐藏调账功能）
  5. 企业用户尝试调账操作时，compMOS再次调用MOS验证权限
  6. MOS校验账户类型，预存企业返回允许，授信企业返回拒绝

### 数据一致性保证

1. **账单数据的主从关系**: MOS为账单数据的主系统（Source of Truth），compMOS为展示系统。所有账单生成、状态变更的最终决策由MOS控制。
2. **最终一致性策略**: compMOS和MOS之间采用最终一致性模型，允许短暂的数据延迟，但需确保延迟时间在可接受范围内（如5秒内）。
3. **冲突解决**: 如compMOS和MOS数据不一致，以MOS数据为准，compMOS定期与MOS同步校验数据。
4. **事务边界**: 跨系统的业务操作（如开票申请提交）需明确定义事务边界，compMOS提交后即视为成功，后续开票由MOS异步执行，失败通过异常通知机制反馈。
5. **操作日志**: 所有跨系统操作必须记录完整的审计日志，包括请求时间、响应时间、请求参数、响应结果、操作人等信息。

### 系统边界

- **compMOS负责**: 企业用户界面、账单展示、开票申请提交、发票下载、预存企业调账提交、用户操作日志记录
  - **技术特点**: 基于 Vue.js 2.x 的单页应用（SPA），使用 Element UI 组件库，遵循 `.cursor/commands/speckit.constitution.md` 编码规范
  - **部署方式**: 打包为静态资源（HTML/CSS/JS），部署至 CDN 或 Web 服务器
  - **数据交互**: 通过 RESTful API 与 MOS 后台通信，使用 Axios 进行 HTTP 请求
  
- **MOS负责**: 账单生成、开票任务调度、第三方开票服务调用、红冲管理、异常处理、后台数据管理、权限管理、结算人员工具
  - **技术特点**: 基于 Vue.js 2.x 的管理后台系统，功能丰富，支持复杂的数据查询和批量操作
  - **部署方式**: 内部部署，仅对运营人员开放
  - **数据交互**: 提供 RESTful API 供 compMOS 调用，通过消息队列处理异步任务
  
- **共同依赖**: 第三方开票服务商API、云存储服务（OSS）、企业SSO认证系统、邮件通知服务、消息队列服务

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 企业用户能够在5分钟内完成一个包含50笔订单的账单包核对流程
- **SC-002**: 90%的发票申请能够在提交后2小时内完成开票并可供下载
- **SC-003**: 结算人员处理单个开票异常的平均时间不超过15分钟
- **SC-004**: 系统支持至少100家企业同时进行对账和开票操作，无明显性能降级
- **SC-005**: 通过平台自动化处理，结算团队在标准业务场景下的人力投入减少60%
- **SC-006**: 95%的企业用户能在首次使用时独立完成从对账到下载发票的完整流程，无需联系结算人员
- **SC-007**: 账单数据导出功能生成的Excel和PDF文件符合企业财务审计要求，格式准确率达到100%
- **SC-008**: 灰度上线期间，试点企业的账单包月度结清率达到85%以上
- **SC-009**: 系统记录的每个账单包生命周期数据完整，可追溯性达到100%
- **SC-010**: 预存企业用户使用调账功能后，订单数据修改成功率达到100%，且修改即时生效

## Assumptions *(mandatory)*

### 业务假设

1. **账单生成时间**: 假设MOS系统在每月1日凌晨自动生成上月账单包，企业在当月5日前完成对账
2. **账单维度**: 假设一期支持两种出账方式：按"支付时间"和按"出行时间"，不同企业可配置不同的出账方式
3. **发票信息存储**: 假设企业的发票抬头、收货地址等信息已在MOS系统中预先配置，企业用户在compMOS仅需确认而非每次填写
4. **开票服务集成**: 假设平台已与第三方开票服务商建立接口，能够自动调用开票API，MOS系统负责与服务商的集成和调度
5. **电子行程单限制**: 假设电子行程单的红冲和重开需要符合航空公司或铁路部门的政策限制，部分场景必须人工介入
6. **火车票换开限制**: 假设火车票仅支持一次换开，超过次数限制后需要结算人员在MOS后台手动处理
7. **付款确认方式**: 假设一期付款环节通过结算人员在MOS后台手动确认，不包含在线支付或银行回单自动识别功能
8. **对账期间新增订单**: 假设对账期间新增的订单按实际发生时间归属账期，如当月账单包已进入"开票中"或之后状态，新订单自动计入下期
9. **业务线范围**: 假设一期仅覆盖001酒店、002机票、003火车三条业务线，004用车、005餐饮、007通用、008保险等业务线在二期考虑

### 技术假设

10. **系统架构**: 假设compMOS和MOS是两个独立部署的系统，通过RESTful API或消息队列进行数据交换
11. **前端技术栈**: 假设compMOS使用 Vue.js 2.7.12 + Element UI 2.13.0 + Vue Router 3.x + Vuex 3.1.2 构建，遵循 `.cursor/commands/speckit.constitution.md` 编码规范
12. **前端构建**: 假设compMOS使用 Webpack 3.x + Babel 6.x 构建，支持 ES6+ 语法，代码经过压缩和混淆
13. **浏览器兼容**: 假设compMOS支持现代浏览器（Chrome 90+、Firefox 88+、Safari 14+、Edge 90+），不考虑 IE 浏览器兼容
14. **用户认证**: 假设企业用户通过企业SSO或易快报统一身份认证系统登录compMOS，结算人员通过内部账号登录MOS
15. **数据安全**: 假设系统符合基本的数据加密和访问控制要求，敏感信息（如发票文件）仅对授权用户可见，前端传输使用HTTPS
16. **数据存储**: 假设账单数据、订单明细、发票记录等数据存储在MOS的数据库中，compMOS通过API查询或接收推送数据
17. **前端缓存**: 假设compMOS使用浏览器本地存储（LocalStorage/SessionStorage）缓存用户会话和常用数据，使用内存缓存（Vuex）管理页面状态
18. **文件存储**: 假设发票PDF文件、账单Excel文件存储在云存储服务（如阿里云OSS），通过签名URL提供下载
19. **数据同步延迟**: 假设compMOS和MOS之间的数据同步延迟在5秒以内，可接受短暂的数据不一致
20. **并发控制**: 假设系统支持基本的并发控制，防止同一账单被多个用户同时修改导致数据不一致
21. **前端性能**: 假设compMOS首屏加载时间在3秒以内，页面交互响应时间在500毫秒以内，使用代码分割和懒加载优化性能
22. **前端部署**: 假设compMOS打包后的静态资源部署至CDN或Web服务器，支持版本化部署和灰度发布

### 业务数据假设

17. **业务线数据来源**: 假设机票、火车票、酒店的订单数据已通过订单系统、支付系统同步至MOS，结算平台不负责订单创建
18. **订单数据完整性**: 假设同步至MOS的订单数据包含完整的订单号、出行人、金额、时间、成本中心等字段，数据质量由上游系统保证
19. **企业基础信息**: 假设企业的基础信息（企业名称、统一社会信用代码、易快报企业ID、账户类型等）已在MOS的企业管理模块中维护
20. **结算人员分配**: 假设每个企业已分配专属的结算人员，结算人员信息存储在MOS系统中

### 运营假设

21. **灰度范围**: 假设灰度阶段选择10-20家预存类小客户进行试点，覆盖月消费金额在10万-50万元的企业
22. **SOP文档维护**: 假设异常处理SOP由产品和运营团队共同维护，随着试点反馈不断迭代优化
23. **结算人员培训**: 假设结算人员已熟悉MOS后台的操作流程，能够熟练处理开票异常、红冲操作等任务
24. **企业用户培训**: 假设在灰度上线前，运营团队会对试点企业的财务人员进行操作培训，降低初次使用的学习成本
25. **客服支持**: 假设compMOS提供企业用户联系结算人员的快捷通道，结算人员能够及时响应企业咨询

### 合规假设

26. **发票合规**: 假设第三方开票服务商提供的发票符合国家税务总局的相关规定，具备法律效力
27. **数据合规**: 假设系统符合《网络安全法》、《数据安全法》、《个人信息保护法》等相关法律法规要求
28. **电子签章**: 假设PDF账单汇总的企业公章使用电子签章服务，具备法律效力

## Out of Scope *(mandatory)*

1. **企业购和通用订单**: 一期不包含企业购（如办公用品采购）和通用订单（非标准化服务）的结算功能
2. **复杂调账逻辑**: 一期不包含跨账单包的调账、历史账单修改、授信企业的在线调账功能
3. **数据权限隔离**: 一期不包含企业内部多部门的数据隔离和权限细分（如财务部门只能看财务数据）
4. **在线支付集成**: 一期不包含在线支付功能，付款环节通过线下转账和后台确认完成
5. **发票自动邮寄**: 一期不包含纸质发票的自动打印和邮寄服务
6. **移动端应用**: 一期仅提供Web端访问，不包含独立的移动App
7. **多语言支持**: 一期仅支持简体中文
8. **高级分析报表**: 一期不包含企业消费趋势分析、成本中心对比等BI分析功能
9. **批量企业导入**: 一期不包含批量导入企业信息和历史账单的功能
10. **开票服务商切换**: 一期不考虑多开票服务商并行或动态切换的场景

## Dependencies *(mandatory)*

### 外部系统依赖

1. **第三方开票服务商**: 
   - **依赖内容**: 系统依赖第三方开票服务商的API稳定性和响应速度，包括增值税普通发票、专用发票、电子行程单、火车票的开具和红冲
   - **影响范围**: 如服务商故障将影响开票功能，企业无法及时获得发票
   - **风险等级**: 高
   - **缓解措施**: 建立开票队列和重试机制，服务商恢复后自动重试；结算人员可手动上传发票作为应急方案

2. **订单数据同步系统**: 
   - **依赖内容**: 系统依赖订单系统、支付系统定期（如每日）同步机票、火车票、酒店的订单数据至MOS
   - **影响范围**: 如数据同步延迟或丢失，可能导致账单不准确，企业对账失败
   - **风险等级**: 高
   - **缓解措施**: 建立数据同步监控机制，每日对账前验证数据完整性；提供手动触发同步功能

3. **企业管理系统**: 
   - **依赖内容**: 系统依赖企业管理系统提供企业的基础信息（如企业名称、统一社会信用代码、易快报企业ID、联系人、账户类型等）
   - **影响范围**: 如企业信息不准确或缺失，可能影响账单生成、开票申请、权限验证等功能
   - **风险等级**: 中
   - **缓解措施**: 在MOS系统中维护企业信息副本，定期同步更新；结算人员可手动维护企业信息

4. **易快报统一身份认证系统**: 
   - **依赖内容**: 系统依赖易快报SSO或统一身份认证系统完成企业用户登录和权限验证
   - **影响范围**: 如认证系统故障，企业用户无法登录compMOS
   - **风险等级**: 高
   - **缓解措施**: 提供备用登录方式（如企业邮箱+验证码）；缓存用户会话，短时间内无需重新认证

5. **电子签章服务**: 
   - **依赖内容**: PDF账单汇总的企业公章功能依赖电子签章服务的可用性
   - **影响范围**: 如签章服务故障，无法生成带公章的PDF账单
   - **风险等级**: 低
   - **缓解措施**: 降级为生成无公章的PDF，结算人员可线下盖章后重新上传

6. **邮件通知服务**: 
   - **依赖内容**: 系统依赖邮件服务发送开票完成、异常通知、账单推送等消息给企业用户和结算人员
   - **影响范围**: 如邮件服务故障，用户无法及时收到通知，需主动登录系统查看
   - **风险等级**: 低
   - **缓解措施**: 提供站内消息通知作为备用；记录所有邮件发送失败日志，服务恢复后批量重发

7. **阿里云OSS云存储服务**: 
   - **依赖内容**: 发票PDF文件、Excel导出文件、红冲批次文件依赖阿里云OSS的稳定性和下载速度
   - **影响范围**: 如OSS故障，用户无法下载发票和账单文件
   - **风险等级**: 中
   - **缓解措施**: 配置OSS多可用区备份；提供CDN加速下载；缓存常用文件在应用服务器

8. **消息队列服务（如RabbitMQ/Kafka）**: 
   - **依赖内容**: compMOS和MOS之间的数据同步、异步任务调度依赖消息队列服务
   - **影响范围**: 如消息队列故障，可能导致数据同步延迟、开票任务积压
   - **风险等级**: 中
   - **缓解措施**: 配置消息队列集群和持久化；提供降级方案，改用数据库轮询或同步API调用

### 前端依赖

9. **Vue.js 核心库**: 
   - **依赖内容**: compMOS依赖 Vue.js 2.7.12 核心框架提供响应式数据绑定和组件化能力
   - **影响范围**: 如 Vue.js 版本升级或弃用，可能需要大规模代码重构
   - **风险等级**: 中
   - **缓解措施**: 使用稳定的长期支持版本（2.7.x）；关注 Vue 3 迁移路径，但一期不考虑升级

10. **Element UI 组件库**: 
    - **依赖内容**: compMOS依赖 Element UI 2.13.0 提供表格、表单、对话框、分页等UI组件
    - **影响范围**: 如 Element UI 出现严重bug或停止维护，可能影响界面展示和交互
    - **风险等级**: 低
    - **缓解措施**: Element UI 2.x 是成熟稳定的版本，社区活跃；必要时可切换至其他组件库（如 Ant Design Vue）

11. **浏览器兼容性**: 
    - **依赖内容**: compMOS依赖现代浏览器的 ES6+ 支持、Fetch API、LocalStorage 等特性
    - **影响范围**: 如用户使用不支持的浏览器，可能出现功能异常或无法访问
    - **风险等级**: 低
    - **缓解措施**: 在登录页面提示浏览器版本要求；使用 Babel 转译 ES6+ 语法；使用 Polyfill 兼容部分API

### 内部模块依赖

12. **MOS账单生成模块**: 
    - **依赖内容**: compMOS依赖MOS定期生成账单包并推送数据
    - **影响范围**: 如MOS账单生成失败，compMOS无数据展示给企业用户
    - **风险等级**: 高
    - **缓解措施**: MOS提供账单生成状态监控；结算人员可手动触发重新生成

13. **MOS开票调度模块**: 
    - **依赖内容**: compMOS的开票申请依赖MOS的开票调度模块执行批次拆分和开票任务
    - **影响范围**: 如MOS开票调度异常，企业提交的开票申请无法执行
    - **风险等级**: 高
    - **缓解措施**: MOS提供开票队列监控和告警；结算人员可查看队列积压并手动处理

14. **MOS权限管理模块**: 
    - **依赖内容**: compMOS依赖MOS提供的权限验证API判断用户操作权限（如调账权限、账单可见性）
    - **影响范围**: 如权限模块异常，可能导致权限校验失败或权限错误
    - **风险等级**: 中
    - **缓解措施**: compMOS缓存用户权限信息，短时间内无需重新验证；提供降级策略，按最小权限原则处理

15. **MOS数据导出模块**: 
    - **依赖内容**: compMOS的账单导出功能依赖MOS生成Excel文件
    - **影响范围**: 如导出模块异常，企业无法下载账单明细
    - **风险等级**: 低
    - **缓解措施**: compMOS提供备用导出功能，直接查询数据库生成Excel

### 政策依赖

16. **航空公司电子行程单政策**: 
    - **依赖内容**: 电子行程单的开具和红冲依赖航空公司的政策支持和接口可用性
    - **影响范围**: 如政策变化或接口升级，可能导致行程单无法在线开具或红冲
    - **风险等级**: 中
    - **缓解措施**: 建立人工兜底流程，结算人员可手动上传行程单；定期与航空公司沟通政策变化

17. **铁路部门火车票政策**: 
    - **依赖内容**: 火车票的换开依赖铁路部门的政策限制（如仅支持一次换开）
    - **影响范围**: 如政策变化，可能影响火车票的红冲和重开流程
    - **风险等级**: 中
    - **缓解措施**: 在MOS系统中配置火车票换开规则，支持灵活调整；提供SOP指导结算人员处理特殊情况

18. **税务总局发票政策**: 
    - **依赖内容**: 增值税发票的开具、红冲依赖国家税务总局的发票管理政策
    - **影响范围**: 如政策变化（如发票代码格式、红冲规则），可能需要系统调整
    - **风险等级**: 低
    - **缓解措施**: 与第三方开票服务商保持沟通，及时响应政策变化；提供灵活的配置能力

## Risks *(mandatory)*

### 技术风险

1. **系统集成风险**: compMOS和MOS是两个独立系统，数据同步和接口调用可能出现延迟、失败或不一致
   - **风险等级**: 高
   - **影响范围**: 影响账单展示、开票申请、状态同步等核心功能
   - **缓解措施**: 
     - 建立健全的接口监控和告警机制，实时监控API调用成功率和响应时间
     - 实现重试机制和降级策略，接口失败时自动重试或切换备用方案
     - 定期进行数据一致性校验，发现不一致时自动或手动修复
     - 记录完整的调用日志，便于问题排查

2. **开票服务商故障风险**: 如第三方开票服务商出现大规模故障，可能导致企业无法及时获得发票，影响财务结算
   - **风险等级**: 高
   - **影响范围**: 影响所有开票申请的执行，企业无法下载发票
   - **缓解措施**: 
     - 建立开票队列和重试机制，服务商恢复后自动重试
     - 结算人员可手动上传发票作为应急方案
     - 与服务商建立SLA协议，明确故障响应时间
     - 评估多服务商备用方案的可行性

3. **数据同步延迟风险**: 如订单数据同步延迟或丢失，可能导致账单不准确，企业对账失败
   - **风险等级**: 高
   - **影响范围**: 影响账单生成的准确性和完整性
   - **缓解措施**: 
     - 建立数据同步监控机制，每日对账前验证数据完整性
     - 提供手动触发同步功能，结算人员可强制重新同步
     - 记录数据同步日志，便于问题排查
     - 设置同步超时告警，及时发现同步异常

4. **消息队列积压风险**: 如开票任务量突然增大，消息队列可能出现积压，导致开票延迟
   - **风险等级**: 中
   - **影响范围**: 影响开票时效，企业等待时间延长
   - **缓解措施**: 
     - 配置消息队列监控和告警，队列积压超过阈值时通知运维人员
     - 提供动态扩容能力，增加消费者实例处理积压任务
     - 优化开票任务调度策略，优先处理紧急任务
     - 向企业用户展示预计完成时间，管理用户预期

5. **并发操作冲突风险**: 同一企业多个财务人员同时操作同一账单包，可能导致数据不一致
   - **风险等级**: 中
   - **影响范围**: 影响数据准确性，可能导致重复核对或状态错误
   - **缓解措施**: 
     - 实现操作锁机制或乐观锁，防止并发修改
     - 提示用户刷新数据，查看最新状态
     - 记录操作日志，便于追溯和恢复
     - 在UI层面提示用户当前有其他人正在操作

6. **文件存储风险**: 如云存储服务（OSS）故障或文件误删除，可能导致发票文件丢失
   - **风险等级**: 中
   - **影响范围**: 影响发票下载，企业无法获取发票文件
   - **缓解措施**: 
     - 配置OSS多可用区备份和版本控制
     - 定期备份重要文件至其他存储服务
     - 限制文件删除权限，仅授权人员可删除
     - 记录文件操作日志，便于恢复误删除的文件

7. **前端性能风险**: 如compMOS前端页面加载缓慢或交互卡顿，可能导致用户体验不佳
   - **风险等级**: 中
   - **影响范围**: 影响用户满意度和使用意愿，增加投诉和流失率
   - **缓解措施**: 
     - 使用代码分割和路由懒加载，减少首屏加载资源
     - 使用虚拟滚动优化大列表渲染性能
     - 使用防抖和节流优化高频操作（如搜索、滚动）
     - 使用浏览器缓存和CDN加速静态资源加载
     - 监控前端性能指标（首屏加载时间、页面交互响应时间、白屏时间）

8. **浏览器兼容性风险**: 如用户使用不支持的浏览器版本，可能出现功能异常或无法访问
   - **风险等级**: 低
   - **影响范围**: 影响部分用户的使用体验
   - **缓解措施**: 
     - 在登录页面明确提示浏览器版本要求
     - 使用 Babel 转译 ES6+ 语法，提高兼容性
     - 使用 Polyfill 兼容部分浏览器API
     - 提供浏览器升级引导和下载链接

### 业务风险

9. **用户操作错误风险**: 企业用户可能误操作（如错误勾选核对、填写错误发票信息），导致需要人工介入修正
   - **风险等级**: 中
   - **影响范围**: 影响数据准确性和用户体验，增加结算人员工作量
   - **缓解措施**: 
     - 提供操作撤销功能，允许用户撤销错误操作
     - 关键操作前增加二次确认提示
     - 提供操作指引和视频教程，降低误操作概率
     - 结算人员在MOS后台可查看和修正错误数据

10. **授信企业调账风险**: 如未来开放授信企业调账功能，可能因修改发票抬头等操作影响还款流程
    - **风险等级**: 高
    - **影响范围**: 影响资金回笼和财务核算
    - **缓解措施**: 
      - 一期严格限制授信企业调账权限，仅由结算人员后台操作
      - 二期如需开放，需建立严格的审批流程和风险控制机制
      - 记录所有调账操作日志，便于追溯和审计
      - 调账操作需关联还款记录，确保资金闭环

11. **开票金额差异风险**: 如系统计算的开票金额与企业预期不一致，可能引发争议
    - **风险等级**: 中
    - **影响范围**: 影响企业信任度，增加客诉和协调成本
    - **缓解措施**: 
      - 在compMOS前台明确展示开票金额计算规则和明细
      - 提供开票金额预估功能，企业申请前可预览
      - 结算人员在MOS后台可查看金额拆分明细，便于解释和核对
      - 建立争议处理流程，结算人员可调整金额并重新开票

12. **红冲规则复杂性风险**: 不同发票类型（增值税发票/火车票/行程单）的红冲规则不同，可能导致操作混乱
    - **风险等级**: 中
    - **影响范围**: 影响红冲操作的准确性和效率
    - **缓解措施**: 
      - 在MOS系统中配置不同发票类型的红冲规则
      - 提供红冲操作指引和SOP文档，指导结算人员处理
      - 系统自动校验红冲条件，不符合规则的操作给出明确提示
      - 记录红冲操作日志，便于追溯和审计

### 政策风险

13. **电子行程单政策风险**: 航空公司或铁路部门政策变化可能导致电子行程单无法在线开具或红冲
    - **风险等级**: 中
    - **影响范围**: 影响行程单开具和红冲功能
    - **缓解措施**: 
      - 建立SOP和人工介入流程，结算人员手动补充数据
      - 与航空公司和铁路部门保持沟通，及时了解政策变化
      - 在MOS系统中配置政策规则，支持灵活调整
      - 向企业用户说明政策限制，管理用户预期

14. **税务政策变化风险**: 国家税务总局发票管理政策变化可能导致系统需要调整
    - **风险等级**: 低
    - **影响范围**: 影响发票开具和管理功能
    - **缓解措施**: 
      - 与第三方开票服务商保持沟通，及时响应政策变化
      - 在MOS系统中提供灵活的配置能力，支持快速调整
      - 建立政策变更评估流程，提前准备应对方案
      - 必要时暂停开票功能，升级完成后再恢复

### 运营风险

15. **灰度范围选择风险**: 如灰度企业选择不当（如业务复杂度高、特殊需求多），可能导致试点效果不佳
    - **风险等级**: 中
    - **影响范围**: 影响产品迭代速度和质量
    - **缓解措施**: 
      - 优先选择预存类小客户，业务模式标准化、消费规模适中的企业
      - 制定明确的灰度企业筛选标准（如月消费金额、业务线数量、历史投诉率等）
      - 灰度期间密切跟踪企业反馈，及时发现和解决问题
      - 建立灰度退出机制，问题严重的企业可暂停使用

16. **用户培训不足风险**: 企业用户初次使用可能不熟悉流程，导致大量咨询请求，增加结算人员工作量
    - **风险等级**: 中
    - **影响范围**: 影响用户体验和运营效率
    - **缓解措施**: 
      - 提供操作指引和视频教程，降低学习成本
      - 建立FAQ文档，覆盖常见问题和解决方案
      - 灰度期间主动培训试点企业，收集反馈并优化产品
      - 在compMOS前台提供在线客服或智能问答功能

17. **结算人员工作量激增风险**: 如compMOS上线后异常量远超预期，可能导致结算人员工作量激增
    - **风险等级**: 中
    - **影响范围**: 影响运营效率和服务质量
    - **缓解措施**: 
      - 灰度上线，逐步扩大覆盖范围，避免一次性上线导致异常集中爆发
      - 优化MOS后台的异常处理工具，提升结算人员处理效率
      - 建立异常分级机制，优先处理高优先级异常
      - 必要时增加结算人员人力或引入自动化工具

18. **数据泄露风险**: 如系统安全防护不足，可能导致企业财务数据泄露
    - **风险等级**: 高
    - **影响范围**: 影响企业信任度和平台声誉，可能面临法律责任
    - **缓解措施**: 
      - 实施严格的数据访问控制，仅授权用户可访问敏感数据
      - 对敏感数据（如发票号、税号）进行加密存储和传输（compMOS前端使用HTTPS，敏感字段前端不明文展示）
      - 定期进行安全审计和渗透测试，发现和修复安全漏洞
      - 建立数据泄露应急响应预案，快速响应和处置安全事件
      - 为企业购买数据安全保险，降低财务损失风险
      - compMOS前端实施XSS防护、CSRF防护，避免前端安全漏洞

## Notes

### 项目背景与定位

- **本规范为一期功能范围**，基于"先跑通核心闭环、再逐步扩展"的策略设计，重点实现对账、开票、付款的基础流程自动化
- **一期功能严格参考携程现有模式**，避免过度创新导致用户理解成本增加，降低用户学习曲线
- **项目核心目标**：通过compMOS前台系统和MOS后台系统的协同，实现企业结算流程的线上化与自动化，显著降低结算团队的人力投入（目标减少60%）
- **compMOS定位**：面向企业财务人员的Web前端应用，提供友好的用户界面和流畅的交互体验，基于 Vue.js 2.x + Element UI 构建，遵循项目统一的编码规范

### 系统架构说明

- **compMOS与MOS的关系**：compMOS是面向企业客户的前台系统，MOS是面向运营人员的后台管理系统，两者通过API和消息队列进行数据交换
- **数据主从关系**：MOS是账单数据的主系统（Source of Truth），负责账单生成、开票调度、异常处理等核心业务逻辑；compMOS是展示系统，负责向企业用户提供友好的交互界面
- **技术边界清晰**：compMOS负责企业用户交互、数据展示、操作提交；MOS负责业务规则执行、第三方服务集成、数据管理和权限控制
- **集成方式灵活**：支持RESTful API、消息队列、数据推送等多种集成方式，根据实际场景选择最合适的方案

### 关键功能说明

- **账单维度灵活**：支持按"支付时间"和按"出行时间"两种出账方式，不同企业可配置不同的出账方式，适应不同的财务核算需求
- **发票类型丰富**：支持增值税普通发票、专用发票、电子行程单、火车票四种发票类型，满足企业多样化的开票需求
- **红冲规则差异化**：不同发票类型的红冲规则不同（增值税发票可随时红冲、火车票仅支持一次换开、行程单存在政策限制），系统需根据类型应用不同规则
- **开票金额拆分**：开票金额按类型拆分（机票票面+改签手续费、票面、退票手续费、服务费、保险费、税额加成、活动/红包等），便于企业财务核算和审计
- **结算人员角色**：结算人员在一期扮演重要的兜底角色，需为其设计高效的后台管理工具（MOS系统），包括账单总览、开票管理、异常处理、红冲管理等功能

### 灰度上线策略

- **灰度上线策略是关键**，需通过试点企业的真实使用反馈迭代优化产品，避免一次性上线导致大规模问题
- **灰度企业筛选标准**：优先选择预存类小客户，业务模式标准化（仅涉及机票、火车票、酒店），消费规模适中（月消费金额10万-50万元），历史投诉率低
- **灰度阶段监控**：密切监控账单生成准确性、开票成功率、系统响应时间、用户操作错误率、异常处理时效等关键指标
- **灰度反馈机制**：建立快速反馈通道，企业用户和结算人员可随时反馈问题，产品和技术团队快速响应并迭代优化

### 重点关注事项

1. **红冲机制的复杂性**（尤其是电子行程单）需要重点关注，建议在技术方案阶段详细调研第三方服务商能力，明确技术实现可行性和限制条件
2. **数据一致性保证**：compMOS和MOS之间的数据同步需确保最终一致性，建立数据校验和修复机制，防止数据不一致导致业务异常
3. **系统性能优化**：账单明细数据量可能很大（单个账单包可能包含数百甚至上千笔订单），需优化数据库查询、前端渲染、文件导出等性能瓶颈
4. **权限控制严格**：预存企业和授信企业的权限差异需严格控制，防止授信企业通过调账影响还款流程，造成资金风险
5. **异常处理完善**：建立完善的异常处理机制和SOP文档，确保结算人员能够快速定位和处理各类异常，保证企业用户的体验

### 参考资料与遵循标准

**业务流程参考**：
- 携程企业结算平台的账单对账、开票申请、发票下载等流程
- MOS系统的账单总览、开票管理、对账单查询等后台管理功能

**数据模型参考**：
- MOS系统的账单包、订单明细、发票、开票批次等实体设计
- 基于MOS实际实现的字段定义和业务含义

**技术标准遵循**：
- RESTful API设计规范、消息队列最佳实践、数据库设计规范
- 前端UI/UX设计规范、响应式设计原则、无障碍访问标准

**前端项目编码规范**：
- **compMOS前端项目**遵循 `.cursor/commands/speckit.constitution.md` 中定义的编码规范
- 技术栈：Vue.js 2.7.12 + Element UI 2.13.0 + Vue Router 3.x + Vuex 3.1.2
- 构建工具：Webpack 3.x + Babel 6.x + ESLint + Prettier
- 代码风格：统一使用 Prettier 格式化（120字符行宽、双引号、分号、2空格缩进）
- 组件命名：PascalCase（如 `InvoiceList.vue`、`BillPackageDetail.vue`）
- API调用：统一使用 `@/api/` 目录下的模块化API文件
- 状态管理：使用 Vuex 管理共享状态，按模块划分 store
- 工具函数：使用 `moment.js` 处理时间、`big.js` 处理精确数值计算、`lodash` 提供工具函数
- 性能优化：组件懒加载、列表虚拟滚动、防抖节流、数据缓存
- 详细编码规范请参考：`.cursor/commands/speckit.constitution.md`

**合规要求遵循**：
- 《网络安全法》、《数据安全法》、《个人信息保护法》
- 国家税务总局发票管理规定
- 企业数据安全和隐私保护标准

### 后续迭代方向

二期功能可考虑以下扩展：
- 支持企业购、通用订单、餐饮、用车、保险等更多业务线
- 支持企业内部多部门的数据权限隔离
- 支持在线支付和银行回单自动识别
- 支持纸质发票的自动打印和邮寄
- 支持移动端应用（iOS/Android App或微信小程序）
- 支持多语言（英文、繁体中文等）
- 提供高级分析报表（企业消费趋势、成本中心对比、供应商分析等）
- 支持多开票服务商并行和智能调度
- 提供AI智能客服和智能问答功能
