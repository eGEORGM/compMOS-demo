(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{314:function(i,n,t){var e=t(18),a=t(345);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[i.i,a,""]]);var o={insert:"head",singleton:!1};e(a,o);i.exports=a.locals||{}},344:function(i,n,t){"use strict";t(314)},345:function(i,n,t){(n=t(19)(!1)).push([i.i,".invoice-apply-page[data-v-002d0b3a] {\n  padding: 24px;\n  background: #f5f7fa;\n  min-height: 100vh;\n}\n.invoice-apply-page .page-header[data-v-002d0b3a] {\n  display: flex;\n  align-items: center;\n  margin-bottom: 24px;\n  gap: 16px;\n}\n.invoice-apply-page .page-header .page-title[data-v-002d0b3a] {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 600;\n  color: #303133;\n}\n.invoice-apply-page .invoice-apply-content .action-card[data-v-002d0b3a] {\n  margin-bottom: 16px;\n}\n.invoice-apply-page .invoice-apply-content .form-card[data-v-002d0b3a] {\n  margin-bottom: 24px;\n}\n.invoice-apply-page .invoice-apply-content .form-card .section-title[data-v-002d0b3a] {\n  font-size: 16px;\n  font-weight: 600;\n  color: #303133;\n  margin-bottom: 16px;\n  padding-bottom: 8px;\n  border-bottom: 2px solid #dcdfe6;\n}\n.invoice-apply-page .invoice-apply-content .footer-actions[data-v-002d0b3a] {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  background: #ffffff;\n  border-top: 1px solid #dcdfe6;\n  padding: 16px 32px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.1);\n  z-index: 100;\n}\n.invoice-apply-page .invoice-apply-content .footer-actions .summary-info[data-v-002d0b3a] {\n  font-size: 14px;\n  color: #909399;\n}\n.invoice-apply-page .invoice-apply-content .footer-actions .summary-info .summary-label[data-v-002d0b3a] {\n  margin: 0 4px;\n}\n.invoice-apply-page .invoice-apply-content .footer-actions .summary-info .summary-value[data-v-002d0b3a] {\n  font-weight: 600;\n  color: #303133;\n  font-size: 16px;\n}\n.invoice-apply-page .invoice-apply-content .footer-actions .summary-info .summary-value.highlight[data-v-002d0b3a] {\n  color: #2555FF;\n  font-size: 24px;\n}\n.invoice-apply-page .confirm-content .confirm-message[data-v-002d0b3a] {\n  font-size: 16px;\n  color: #303133;\n  margin-bottom: 24px;\n}\n.invoice-apply-page .confirm-content .confirm-summary[data-v-002d0b3a] {\n  background: #f5f7fa;\n  padding: 16px;\n  border-radius: 4px;\n  margin-bottom: 24px;\n  max-height: 400px;\n  overflow-y: auto;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row[data-v-002d0b3a] {\n  padding: 16px;\n  background: #ffffff;\n  border-radius: 4px;\n  margin-bottom: 8px;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row[data-v-002d0b3a]:last-child {\n  margin-bottom: 0;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row .summary-item[data-v-002d0b3a] {\n  display: flex;\n  margin-bottom: 4px;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row .summary-item[data-v-002d0b3a]:last-child {\n  margin-bottom: 0;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row .summary-item .label[data-v-002d0b3a] {\n  color: #909399;\n  min-width: 80px;\n  font-size: 13px;\n}\n.invoice-apply-page .confirm-content .confirm-summary .summary-row .summary-item .value[data-v-002d0b3a] {\n  flex: 1;\n  color: #303133;\n  font-weight: 500;\n}\n.invoice-apply-page .confirm-content .confirm-hint[data-v-002d0b3a] {\n  font-size: 13px;\n  color: #c0c4cc;\n  margin: 0;\n  text-align: center;\n}\n",""]),i.exports=n},348:function(i,n,t){"use strict";t.r(n);var e=t(33),a=t(160),o=t(161),s=t(315),l=t(316),c={name:"InvoiceApply",components:{InvoiceForm:s.a,InvoiceSplitConfig:l.a},data(){return{billNo:this.$route.params.billNo,confirmDialogVisible:!1,splitConfigVisible:!1,invoiceRows:[],loading:!1,submitting:!1,splitConfig:{dimension1:"",dimension2:""}}},computed:{...Object(e.c)("invoice",["invoiceTitles","invoiceSummary"]),invoiceRowCount(){return this.invoiceRows.length},totalAmount(){return this.invoiceRows.reduce((i,n)=>i+(n.amount||0),0)},validInvoiceRows(){return this.invoiceRows.filter(i=>i.isValid)},canSubmit(){return this.validInvoiceRows.length>0&&this.validInvoiceRows.length===this.invoiceRows.length}},created(){this.loadData()},methods:{...Object(e.b)("invoice",["fetchInvoiceSummary","fetchInvoiceTitles","submitInvoiceApplication","updateSplitConfig"]),async loadData(){this.loading=!0;try{await Promise.all([this.fetchInvoiceSummary(this.billNo),this.fetchInvoiceTitles()]),this.initInvoiceRows()}catch(i){Object(o.a)(i,{customMessage:"加载开票数据失败"})}finally{this.loading=!1}},initInvoiceRows(){this.invoiceSummary&&this.invoiceSummary.invoiceDetails&&(this.invoiceRows=this.invoiceSummary.invoiceDetails.filter(i=>i.remainingAmount>0).map(i=>({invoiceType:i.type,summary:i.summary,amount:i.remainingAmount,orderCount:i.orderCount,titleId:"",titleName:"",receiverName:"",receiverPhone:"",receiverEmail:"",receiverAddress:"",unit:"元",quantity:1,isValid:!1})))},handleFormUpdate(i){this.invoiceRows=i},handleSplitConfig(){this.splitConfigVisible=!0},async handleSplitConfigSave(i){try{await this.updateSplitConfig({enabled:!0,dimension1:i.dimension1,dimension2:i.dimension2}),this.splitConfig={...i},this.generateInvoiceRowsBySplit(),Object(o.b)("拆分汇总配置已应用")}catch(i){Object(o.a)(i,{customMessage:"保存拆分配置失败"})}},generateInvoiceRowsBySplit(){if(!this.invoiceSummary||!this.invoiceSummary.invoiceDetails)return;const{dimension1:i,dimension2:n}=this.splitConfig;if(!i)return void this.initInvoiceRows();const t=this.invoiceSummary.invoiceDetails||[],e=[];t.forEach(t=>{if(t.remainingAmount>0)if("BUSINESS_LINE"===i){const i=["机票","酒店","火车票"];i.forEach(a=>{const o=t.remainingAmount/i.length;o>0&&e.push({invoiceType:t.type,summary:`${a} - ${t.summary}`,amount:parseFloat(o.toFixed(2)),orderCount:Math.ceil(t.orderCount/i.length),titleId:"",titleName:"",receiverName:"",receiverPhone:"",receiverEmail:"",receiverAddress:"",unit:"元",quantity:1,isValid:!1,splitDimension1:a,splitDimension2:n?"":void 0})})}else if("LEGAL_ENTITY"===i){const i=["北京分公司","上海分公司"];i.forEach(a=>{const o=t.remainingAmount/i.length;o>0&&e.push({invoiceType:t.type,summary:`${a} - ${t.summary}`,amount:parseFloat(o.toFixed(2)),orderCount:Math.ceil(t.orderCount/i.length),titleId:"",titleName:"",receiverName:"",receiverPhone:"",receiverEmail:"",receiverAddress:"",unit:"元",quantity:1,isValid:!1,splitDimension1:a,splitDimension2:n?"":void 0})})}else e.push({invoiceType:t.type,summary:t.summary,amount:t.remainingAmount,orderCount:t.orderCount,titleId:"",titleName:"",receiverName:"",receiverPhone:"",receiverEmail:"",receiverAddress:"",unit:"元",quantity:1,isValid:!1})}),this.invoiceRows=e},handleBack(){this.$router.push({name:"BillDetail",params:{billNo:this.billNo}})},handleSubmit(){this.$refs.invoiceForm.validate()?this.confirmDialogVisible=!0:Object(o.c)("请填写完整的开票信息")},async confirmSubmit(){this.submitting=!0;try{await this.submitInvoiceApplication({billNo:this.billNo,invoiceRows:this.validInvoiceRows}),Object(o.b)("开票申请提交成功"),this.confirmDialogVisible=!1,this.$router.push({name:"BillDetail",params:{billNo:this.billNo},query:{tab:"invoice"}})}catch(i){Object(o.a)(i,{customMessage:"开票申请提交失败"})}finally{this.submitting=!1}},formatAmount:i=>Object(a.a)(i)}},r=(t(344),t(12)),m=Object(r.a)(c,(function(){var i=this,n=i._self._c;return n("div",{staticClass:"invoice-apply-page"},[n("div",{staticClass:"page-header"},[n("el-button",{attrs:{icon:"el-icon-arrow-left",size:"small"},on:{click:i.handleBack}},[i._v("\n      返回\n    ")]),i._v(" "),n("h2",{staticClass:"page-title"},[i._v("填写开票信息")])],1),i._v(" "),n("div",{directives:[{name:"loading",rawName:"v-loading",value:i.loading,expression:"loading"}],staticClass:"invoice-apply-content"},[n("el-card",{staticClass:"action-card",attrs:{shadow:"never"}},[n("el-button",{attrs:{icon:"el-icon-folder-opened"},on:{click:i.handleSplitConfig}},[i._v("\n        拆分汇总\n      ")])],1),i._v(" "),n("el-card",{staticClass:"form-card",attrs:{shadow:"never"}},[n("h3",{staticClass:"section-title"},[i._v("开票信息")]),i._v(" "),n("invoice-form",{ref:"invoiceForm",attrs:{"bill-no":i.billNo,"invoice-rows":i.invoiceRows,"invoice-titles":i.invoiceTitles,"split-config":i.splitConfig},on:{update:i.handleFormUpdate}})],1),i._v(" "),n("div",{staticClass:"footer-actions"},[n("div",{staticClass:"summary-info"},[n("span",{staticClass:"summary-label"},[i._v("共")]),i._v(" "),n("span",{staticClass:"summary-value"},[i._v(i._s(i.invoiceRowCount))]),i._v(" "),n("span",{staticClass:"summary-label"},[i._v("行开票信息，总金额")]),i._v(" "),n("span",{staticClass:"summary-value highlight"},[i._v(i._s(i.formatAmount(i.totalAmount)))]),i._v(" "),n("span",{staticClass:"summary-label"},[i._v("元")])]),i._v(" "),n("el-button",{attrs:{type:"primary",size:"large",loading:i.submitting,disabled:!i.canSubmit},on:{click:i.handleSubmit}},[i._v("\n        申请开票\n      ")])],1)],1),i._v(" "),n("invoice-split-config",{attrs:{"current-config":i.splitConfig},on:{save:i.handleSplitConfigSave},model:{value:i.splitConfigVisible,callback:function(n){i.splitConfigVisible=n},expression:"splitConfigVisible"}}),i._v(" "),n("el-dialog",{attrs:{title:"确认开票信息",visible:i.confirmDialogVisible,width:"600px","close-on-click-modal":!1},on:{"update:visible":function(n){i.confirmDialogVisible=n}}},[n("div",{staticClass:"confirm-content"},[n("p",{staticClass:"confirm-message"},[i._v("请确认以下开票信息：")]),i._v(" "),n("div",{staticClass:"confirm-summary"},i._l(i.validInvoiceRows,(function(t,e){return n("div",{key:e,staticClass:"summary-row"},[n("div",{staticClass:"summary-item"},[n("span",{staticClass:"label"},[i._v("发票种类：")]),i._v(" "),n("span",{staticClass:"value"},[i._v(i._s(t.invoiceType))])]),i._v(" "),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"label"},[i._v("开票金额：")]),i._v(" "),n("span",{staticClass:"value"},[i._v(i._s(i.formatAmount(t.amount)))])]),i._v(" "),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"label"},[i._v("发票抬头：")]),i._v(" "),n("span",{staticClass:"value"},[i._v(i._s(t.titleName))])]),i._v(" "),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"label"},[i._v("接收人：")]),i._v(" "),n("span",{staticClass:"value"},[i._v(i._s(t.receiverName)+" "+i._s(t.receiverPhone))])])])})),0),i._v(" "),n("p",{staticClass:"confirm-hint"},[i._v("确认提交后将开始开票流程，请仔细核对信息。")])]),i._v(" "),n("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[n("el-button",{on:{click:function(n){i.confirmDialogVisible=!1}}},[i._v("取消")]),i._v(" "),n("el-button",{attrs:{type:"primary",loading:i.submitting},on:{click:i.confirmSubmit}},[i._v("确定提交")])],1)])],1)}),[],!1,null,"002d0b3a",null);n.default=m.exports}}]);