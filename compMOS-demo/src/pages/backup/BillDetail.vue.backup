<template>
  <div class="bill-detail-page">
    <!-- 面包屑 -->
    <div class="breadcrumb-container">
      <span class="breadcrumb-item" @click="$router.back()">对账</span>
      <span class="breadcrumb-separator">></span>
      <span class="breadcrumb-item active">消费单明细</span>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="loading-container">
      <el-skeleton :rows="8" animated />
    </div>

    <!-- 账单内容 -->
    <div v-else-if="bill" class="bill-content">
      <!-- 流程步骤条 -->
      <el-card class="steps-card">
        <el-steps :active="currentStep" finish-status="success" align-center>
          <el-step title="开始对账"></el-step>
          <el-step title="确认账单"></el-step>
          <el-step title="核交发票"></el-step>
          <el-step title="付款"></el-step>
          <el-step title="已结清"></el-step>
        </el-steps>
      </el-card>

      <!-- 日期和操作区域 -->
      <el-card class="action-card">
        <div class="action-header">
          <div class="date-range">
            <i class="el-icon-date"></i>
            {{ formatBillCycleRange(bill.billCycle) }}
          </div>
          <div class="action-buttons">
            <el-button
              v-if="bill.billStatus === BILL_STATUS.PENDING"
              type="primary"
              :loading="confirmLoading"
              @click="handleConfirmBill"
            >
              确认账单
            </el-button>
            <el-button icon="el-icon-folder-opened">折分汇总</el-button>
            <el-button icon="el-icon-download">导出全部Excel</el-button>
            <el-button icon="el-icon-download">导出全部PDF</el-button>
          </div>
        </div>
      </el-card>

      <!-- 标签页和内容区域 -->
      <el-row :gutter="16">
        <!-- 左侧主内容区 -->
        <el-col :xs="24" :lg="16">
          <!-- 标签页 -->
          <el-card class="tabs-card">
            <el-tabs v-model="activeTab">
              <!-- 开票汇总 -->
              <el-tab-pane label="开票汇总" name="invoice">
                <div class="invoice-summary">
                  <!-- 开票金额统计 -->
                  <div class="invoice-amounts">
                    <div class="amount-item">
                      <div class="amount-label">应开票金额</div>
                      <div class="amount-value">{{ formatNumber(bill.totalAmount) }}</div>
                    </div>
                    <div class="amount-item">
                      <div class="amount-label">已开票金额</div>
                      <div class="amount-value">{{ formatNumber(invoicedAmount) }}</div>
                    </div>
                    <div class="amount-item highlighted">
                      <div class="amount-label">还可提交金额</div>
                      <div class="amount-value">{{ formatNumber(remainingAmount) }}</div>
                    </div>
                  </div>

                  <!-- 发票明细表格 -->
                  <div class="invoice-details">
                    <el-table :data="invoiceDetails" border style="width: 100%">
                      <el-table-column prop="type" label="发票种类" width="150"></el-table-column>
                      <el-table-column prop="summary" label="发票摘要" width="120"></el-table-column>
                      <el-table-column prop="shouldAmount" label="应开票金额" align="right">
                        <template slot-scope="scope">{{ formatNumber(scope.row.shouldAmount) }}</template>
                      </el-table-column>
                      <el-table-column prop="invoicedAmount" label="已开票金额" align="right">
                        <template slot-scope="scope">{{ formatNumber(scope.row.invoicedAmount) }}</template>
                      </el-table-column>
                      <el-table-column prop="remainingAmount" label="还可提交金额" align="right">
                        <template slot-scope="scope">{{ formatNumber(scope.row.remainingAmount) }}</template>
                      </el-table-column>
                    </el-table>
                  </div>

                  <!-- 开票申请记录 -->
                  <div class="invoice-applications">
                    <div class="application-header">
                      <h4>开票申请记录</h4>
                      <div class="application-actions">
                        <el-button size="small" icon="el-icon-download">下载全部发票</el-button>
                        <el-button size="small" icon="el-icon-view">查看保险发票</el-button>
                      </div>
                    </div>

                    <!-- 标签切换 -->
                    <el-tabs v-model="invoiceApplicationTab" class="invoice-tabs">
                      <el-tab-pane label="统一开发票" name="unified">
                        <el-table :data="invoiceApplications" border style="width: 100%">
                          <el-table-column prop="type" label="发票类型" width="150"></el-table-column>
                          <el-table-column prop="content" label="发票内容" width="150"></el-table-column>
                          <el-table-column prop="amount" label="开票金额" align="right">
                            <template slot-scope="scope">{{ formatNumber(scope.row.amount) }}</template>
                          </el-table-column>
                          <el-table-column prop="title" label="发票抬头" width="200"></el-table-column>
                          <el-table-column prop="submitter" label="提交人" width="100"></el-table-column>
                          <el-table-column prop="applyTime" label="申请时间" width="160">
                            <template slot-scope="scope">{{ formatDateTime(scope.row.applyTime) }}</template>
                          </el-table-column>
                          <el-table-column prop="status" label="状态" width="100" align="center">
                            <template slot-scope="scope">
                              <el-tag :type="scope.row.status === '已完成' ? 'success' : 'warning'" size="small">
                                {{ scope.row.status }}
                              </el-tag>
                            </template>
                          </el-table-column>
                          <el-table-column label="操作" width="150" fixed="right">
                            <template slot-scope="scope">
                              <el-button type="text" size="small" @click="handleViewInvoice(scope.row)">
                                查看详情
                              </el-button>
                              <el-button type="text" size="small" @click="handleDownloadInvoice(scope.row)">
                                下载
                              </el-button>
                            </template>
                          </el-table-column>
                        </el-table>
                      </el-tab-pane>
                      <el-tab-pane label="非统一开发票" name="separate"></el-tab-pane>
                    </el-tabs>

                    <div class="batch-actions">
                      <el-button type="primary" plain>批量下载</el-button>
                    </div>
                  </div>
                </div>
              </el-tab-pane>

              <!-- 预存汇总 -->
              <el-tab-pane label="预存汇总" name="summary">
                <!-- 账单金额 -->
                <div class="amount-summary">
                  <div class="amount-header">账单金额</div>
                  <div class="total-amount">
                    <span class="amount-value">{{ formatNumber(bill.totalAmount) }}</span>
                  </div>
                  <el-collapse v-model="collapseActive">
                    <el-collapse-item name="1">
                      <template slot="title">
                        <span class="collapse-title">本期账单消费金额</span>
                        <span class="collapse-amount">{{ formatNumber(bill.totalAmount) }}</span>
                      </template>
                      <div class="amount-detail">
                        <div class="detail-row">
                          <span>消费金额合计</span>
                          <span class="amount">{{ formatAmount(bill.totalAmount) }}</span>
                        </div>
                      </div>
                    </el-collapse-item>
                  </el-collapse>
                </div>
              </el-tab-pane>

              <!-- 预存机票 -->
              <el-tab-pane label="预存机票" name="flight">
                <!-- 搜索区域 -->
                <div class="search-bar">
                  <el-input
                    v-model="searchForm.orderNo"
                    placeholder="订单号："
                    style="width: 200px; margin-right: 10px"
                  ></el-input>
                  <el-input
                    v-model="searchForm.cardNo"
                    placeholder="持卡人卡号："
                    style="width: 200px; margin-right: 10px"
                  ></el-input>
                  <el-input
                    v-model="searchForm.passenger"
                    placeholder="乘机人："
                    style="width: 200px; margin-right: 10px"
                  ></el-input>
                  <el-button type="primary">查询</el-button>
                  <el-button>批量查询</el-button>
                  <el-button>展开更多</el-button>
                </div>

                <!-- 操作按钮 -->
                <div class="table-actions">
                  <el-checkbox>选中所有页</el-checkbox>
                  <el-button size="small">查询验真</el-button>
                  <el-button size="small">配置字段</el-button>
                  <el-button size="small">排序</el-button>
                  <el-button size="small">导出Excel</el-button>
                  <el-button size="small">导出PDF</el-button>
                </div>

                <!-- 订单表格 -->
                <el-table :data="flightOrders" border stripe style="width: 100%">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="ticketNo" label="核对" width="80"></el-table-column>
                  <el-table-column prop="orderNo" label="订单号" width="180"></el-table-column>
                  <el-table-column prop="businessInfo.cardNo" label="卡号" width="120">
                    <template slot-scope="scope">{{ scope.row.businessInfo && scope.row.businessInfo.cardNo || '2196093865' }}</template>
                  </el-table-column>
                  <el-table-column prop="bookerName" label="持卡人" width="100"></el-table-column>
                  <el-table-column prop="travelerName" label="乘机人" width="100"></el-table-column>
                  <el-table-column prop="payTime" label="预订日期" width="160">
                    <template slot-scope="scope">{{ formatDateTime(scope.row.payTime) }}</template>
                  </el-table-column>
                  <el-table-column prop="travelTime" label="起飞时间" width="160">
                    <template slot-scope="scope">{{ formatDateTime(scope.row.travelTime) }}</template>
                  </el-table-column>
                  <el-table-column label="国际" width="80" align="center">
                    <template>国际</template>
                  </el-table-column>
                </el-table>

                <!-- 总计和分页 -->
                <div class="table-footer">
                  <div class="total-summary">
                    <span>总计金额：</span>
                    <span class="total-amount">{{ formatNumber(flightTotal) }}</span>
                  </div>
                  <div class="pagination">
                    <span>共有 {{ flightOrders.length }} 条</span>
                    <el-pagination
                      :current-page="1"
                      :page-size="100"
                      :total="flightOrders.length"
                      layout="prev, pager, next"
                    ></el-pagination>
                    <span>100 条/页</span>
                  </div>
                </div>
              </el-tab-pane>

              <!-- 预存会员酒店 -->
              <el-tab-pane label="预存会员酒店" name="hotel">
                <OrderTable :orders="hotelOrders" :show-checkbox="false" />
              </el-tab-pane>
            </el-tabs>
          </el-card>

          <!-- 凭证汇总 -->
          <el-card class="voucher-card" style="margin-top: 16px">
            <div slot="header">凭证汇总</div>
            <div class="voucher-content">
              <el-empty description="暂无凭证信息"></el-empty>
            </div>
          </el-card>
        </el-col>

        <!-- 右侧信息卡片 -->
        <el-col :xs="24" :lg="8">
          <!-- 基础信息 -->
          <el-card class="info-card">
            <div slot="header">基础信息</div>
            <div class="info-content">
              <div class="info-row">
                <span class="info-label">公司名称</span>
                <span class="info-value">{{ bill.companyName }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">主账户名称</span>
                <span class="info-value">{{ userInfo.userId }}_主账户1</span>
              </div>
              <div class="info-row">
                <span class="info-label">子批次</span>
                <span class="info-value">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">结算方式</span>
                <span class="info-value">{{ bill.accountType === 1 ? "预付" : "授信" }}</span>
              </div>
            </div>
          </el-card>

          <!-- 收款信息 -->
          <el-card class="info-card" style="margin-top: 16px">
            <div slot="header">收款信息</div>
            <div class="info-content">
              <div class="info-row">
                <span class="info-label">收款银行名称</span>
                <span class="info-value">上海携程宏宇国际旅行社有限公司</span>
              </div>
              <div class="info-row">
                <span class="info-label">银行账号</span>
                <span class="info-value">95588510010281117055</span>
              </div>
              <div class="info-row">
                <span class="info-label">收款开户行</span>
                <span class="info-value">中国工商银行股份有限公司上海市清河泾支行</span>
              </div>
              <div class="info-row">
                <span class="info-label">付款编码</span>
                <span class="info-value">{{ bill.billNo.toLowerCase() }}</span>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- 空状态 -->
    <div v-else class="empty-container">
      <el-empty description="账单不存在">
        <el-button type="primary" @click="$router.back()">返回列表</el-button>
      </el-empty>
    </div>

    <!-- 确认对话框 -->
    <ConfirmDialog
      :visible.sync="confirmDialogVisible"
      title="确认账单"
      message="确认后账单状态将变为「已核对」，是否继续？"
      :loading="confirmLoading"
      @confirm="handleConfirmSubmit"
    />
  </div>
</template>

<script>
import OrderTable from "@/components/bill/OrderTable.vue";
import ConfirmDialog from "@/components/common/ConfirmDialog.vue";
import { getBillByNo, updateBillStatus } from "@/mock/bills";
import { getOrdersByBillNo } from "@/mock/orders";
import { getCurrentUser } from "@/mock/users";
import { BILL_STATUS, BUSINESS_TYPE } from "@/utils/constants";
import { formatAmount, formatNumber } from "@/utils/format";

export default {
  name: "BillDetail",
  components: {
    OrderTable,
    ConfirmDialog
  },
  data() {
    return {
      BILL_STATUS,
      bill: null,
      orders: [],
      selectedOrders: [],
      loading: false,
      confirmDialogVisible: false,
      confirmLoading: false,
      activeTab: "invoice",
      collapseActive: ["1"],
      userInfo: null,
      invoiceApplicationTab: "unified",
      searchForm: {
        orderNo: "",
        cardNo: "",
        passenger: ""
      },
      // 开票数据
      invoicedAmount: 0,
      invoiceDetails: [],
      invoiceApplications: []
    };
  },
  computed: {
    billNo() {
      return this.$route.params.billNo;
    },
    currentStep() {
      // 根据账单状态返回当前步骤
      const stepMap = {
        0: 0, // 待对账 -> 开始对账
        1: 1, // 已核对 -> 确认账单
        2: 2, // 开票中 -> 核交发票
        3: 4 // 已结清 -> 已结清
      };
      return this.bill && stepMap[this.bill.billStatus] !== undefined ? stepMap[this.bill.billStatus] : 0;
    },
    flightOrders() {
      return this.orders.filter((o) => o.businessType === BUSINESS_TYPE.FLIGHT);
    },
    hotelOrders() {
      return this.orders.filter((o) => o.businessType === BUSINESS_TYPE.HOTEL);
    },
    trainOrders() {
      return this.orders.filter((o) => o.businessType === BUSINESS_TYPE.TRAIN);
    },
    flightTotal() {
      return this.flightOrders.reduce((sum, order) => sum + order.payAmount, 0);
    },
    remainingAmount() {
      return this.bill ? this.bill.totalAmount - this.invoicedAmount : 0;
    }
  },
  mounted() {
    this.userInfo = getCurrentUser();
    this.loadBillDetail();
  },
  methods: {
    formatAmount,
    formatNumber,
    formatBillCycleRange(cycle) {
      if (!cycle) return "-";
      const [year, month] = cycle.split("-");
      const startDate = `${year}年${month}月01日`;
      const endDay = new Date(year, month, 0).getDate();
      const endDate = `${year}年${month}月${endDay}日`;
      return `${startDate}-${endDate}`;
    },
    loadBillDetail() {
      this.loading = true;
      setTimeout(() => {
        this.bill = getBillByNo(this.billNo);
        if (this.bill) {
          this.orders = getOrdersByBillNo(this.billNo);
          this.initInvoiceData();
        }
        this.loading = false;
      }, 500);
    },
    initInvoiceData() {
      // 根据账单状态初始化开票数据
      if (this.bill.billStatus >= 2) {
        // 已开票或已结清
        this.invoicedAmount = this.bill.totalAmount;
      } else {
        this.invoicedAmount = 0;
      }

      // 生成发票明细
      this.invoiceDetails = [
        {
          type: "增值税普通发票",
          summary: "机票住宿费",
          shouldAmount: this.bill.totalAmount,
          invoicedAmount: this.invoicedAmount,
          remainingAmount: this.bill.totalAmount - this.invoicedAmount
        },
        {
          type: "增值税普通发票",
          summary: "保险费",
          shouldAmount: 0,
          invoicedAmount: 0,
          remainingAmount: 0
        }
      ];

      // 生成开票申请记录（如果已开票）
      if (this.bill.billStatus >= 2) {
        this.invoiceApplications = [
          {
            type: "增值税普通发票",
            content: "机票住宿费",
            amount: this.bill.totalAmount,
            title: "厦门合思宏盛有限公司",
            submitter: "高溪",
            applyTime: this.bill.confirmTime || new Date().toISOString(),
            status: "已完成"
          }
        ];
      }
    },
    handleSelectionChange(selection) {
      this.selectedOrders = selection;
    },
    handleConfirmBill() {
      this.confirmDialogVisible = true;
    },
    handleConfirmSubmit() {
      this.confirmLoading = true;

      setTimeout(() => {
        updateBillStatus(this.billNo, BILL_STATUS.CONFIRMED);
        this.bill.billStatus = BILL_STATUS.CONFIRMED;
        this.bill.confirmTime = new Date().toISOString();

        this.confirmLoading = false;
        this.confirmDialogVisible = false;

        this.$message.success("账单确认成功");

        setTimeout(() => {
          this.$router.back();
        }, 1000);
      }, 1500);
    },
    handleViewInvoice(row) {
      this.$message.info(`查看发票：${row.type}`);
    },
    handleDownloadInvoice(row) {
      this.$message.success(`下载发票：${row.type}`);
    }
  }
};
</script>

<style lang="less" scoped>
@import "~@/assets/styles/variables.less";

.bill-detail-page {
  // 面包屑
  .breadcrumb-container {
    background: @bg-white;
    padding: @spacing-md @spacing-lg;
    margin-bottom: @spacing-md;
    border-radius: @radius-md;
    font-size: @font-size-base;

    .breadcrumb-item {
      color: @text-secondary;
      cursor: pointer;

      &:hover {
        color: @primary-color;
      }

      &.active {
        color: @text-primary;
        cursor: default;
      }
    }

    .breadcrumb-separator {
      margin: 0 @spacing-sm;
      color: @text-placeholder;
    }
  }

  // 步骤条卡片
  .steps-card {
    margin-bottom: @spacing-md;
  }

  // 操作区域
  .action-card {
    margin-bottom: @spacing-md;

    .action-header {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .date-range {
        font-size: @font-size-md;
        color: @text-regular;
        display: flex;
        align-items: center;
        gap: @spacing-sm;

        i {
          font-size: 18px;
          color: @primary-color;
        }
      }

      .action-buttons {
        display: flex;
        gap: @spacing-sm;
      }
    }
  }

  // 标签页卡片
  .tabs-card {
    // 金额汇总区域
    .amount-summary {
      .amount-header {
        font-size: @font-size-sm;
        color: @text-secondary;
        margin-bottom: @spacing-sm;
      }

      .total-amount {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: @spacing-xl @spacing-lg;
        border-radius: @radius-md;
        margin-bottom: @spacing-md;

        .amount-value {
          font-size: 36px;
          font-weight: 600;
          color: #fff;
        }
      }

      /deep/ .el-collapse {
        border: none;

        .el-collapse-item {
          .el-collapse-item__header {
            background: @bg-lighter;
            padding: @spacing-md @spacing-lg;
            border: none;
            border-radius: @radius-md;

            .collapse-title {
              flex: 1;
              font-size: @font-size-base;
              color: @text-regular;
            }

            .collapse-amount {
              font-size: @font-size-md;
              font-weight: 600;
              color: @text-primary;
              margin-right: @spacing-md;
            }
          }

          .el-collapse-item__wrap {
            border: none;
          }

          .el-collapse-item__content {
            padding: @spacing-md @spacing-lg;
          }
        }
      }

      .amount-detail {
        .detail-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: @spacing-sm 0;
          font-size: @font-size-base;

          .amount {
            font-weight: 600;
            color: @danger-color;
          }
        }
      }
    }

    // 开票汇总样式
    .invoice-summary {
      .invoice-amounts {
        display: flex;
        gap: 20px;
        margin-bottom: 24px;
        padding: 24px;
        background: @bg-lighter;
        border-radius: @radius-md;

        .amount-item {
          flex: 1;
          text-align: center;
          padding: 16px;
          background: @bg-white;
          border-radius: @radius-sm;

          &.highlighted {
            background: @primary-color;
            color: @bg-white;

            .amount-label,
            .amount-value {
              color: @bg-white;
            }
          }

          .amount-label {
            font-size: @font-size-sm;
            color: @text-secondary;
            margin-bottom: 8px;
          }

          .amount-value {
            font-size: 24px;
            font-weight: 600;
            color: @text-primary;
          }
        }
      }

      .invoice-details {
        margin-bottom: 24px;
      }

      .invoice-applications {
        .application-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: @spacing-md;

          h4 {
            margin: 0;
            font-size: @font-size-md;
            font-weight: 500;
          }

          .application-actions {
            display: flex;
            gap: @spacing-sm;
          }
        }

        .invoice-tabs {
          margin-top: @spacing-md;
        }

        .batch-actions {
          margin-top: @spacing-md;
          text-align: right;
        }
      }
    }

    // 搜索区域样式
    .search-bar {
      display: flex;
      align-items: center;
      margin-bottom: @spacing-md;
      padding: @spacing-md;
      background: @bg-lighter;
      border-radius: @radius-md;
    }

    // 表格操作按钮
    .table-actions {
      display: flex;
      align-items: center;
      gap: @spacing-sm;
      margin-bottom: @spacing-md;
      padding: @spacing-sm @spacing-md;
      background: @bg-lighter;
      border-radius: @radius-md;
    }

    // 表格底部
    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: @spacing-md;
      padding: @spacing-md;
      background: @bg-lighter;
      border-radius: @radius-md;

      .total-summary {
        font-size: @font-size-base;
        font-weight: 500;

        .total-amount {
          font-size: @font-size-lg;
          color: @primary-color;
          margin-left: @spacing-sm;
        }
      }

      .pagination {
        display: flex;
        align-items: center;
        gap: @spacing-md;
      }
    }
  }

  // 凭证卡片
  .voucher-card {
    .voucher-content {
      min-height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  }

  // 信息卡片
  .info-card {
    .info-content {
      .info-row {
        display: flex;
        justify-content: space-between;
        padding: @spacing-md 0;
        border-bottom: 1px solid @border-lighter;
        font-size: @font-size-sm;

        &:last-child {
          border-bottom: none;
        }

        .info-label {
          color: @text-secondary;
          width: 100px;
          flex-shrink: 0;
        }

        .info-value {
          flex: 1;
          color: @text-regular;
          text-align: right;
          word-break: break-all;
        }
      }
    }
  }

  // 加载和空状态
  .loading-container,
  .empty-container {
    background: @bg-white;
    padding: @spacing-xl * 2;
    border-radius: @radius-md;
    min-height: 400px;
  }

  .empty-container {
    display: flex;
    justify-content: center;
    align-items: center;
  }
}
</style>

